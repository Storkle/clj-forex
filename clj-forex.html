<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
lang="en" xml:lang="en">
<head>
<title>CLJ-FOREX</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2011-01-13 16:47:22 CST"/>
<meta name="author" content="Seth Burleigh"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  html { font-family: Times, serif; font-size: 12pt; }
  .title  { text-align: center; }
  .todo   { color: red; }
  .done   { color: green; }
  .tag    { background-color: #add8e6; font-weight:normal }
  .target { }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  {margin-left:auto; margin-right:0px;  text-align:right;}
  .left   {margin-left:0px;  margin-right:auto; text-align:left;}
  .center {margin-left:auto; margin-right:auto; text-align:center;}
  p.verse { margin-left: 3% }
  pre {
	border: 1pt solid #AEBDCC;
	background-color: #F3F5F7;
	padding: 5pt;
	font-family: courier, monospace;
        font-size: 90%;
        overflow:auto;
  }
  table { border-collapse: collapse; }
  td, th { vertical-align: top;  }
  th.right  { text-align:center;  }
  th.left   { text-align:center;   }
  th.center { text-align:center; }
  td.right  { text-align:right;  }
  td.left   { text-align:left;   }
  td.center { text-align:center; }
  dt { font-weight: bold; }
  div.figure { padding: 0.5em; }
  div.figure p { text-align: center; }
  textarea { overflow-x: auto; }
  .linenr { font-size:smaller }
  .code-highlighted {background-color:#ffff00;}
  .org-info-js_info-navigation { border-style:none; }
  #org-info-js_console-label { font-size:10px; font-weight:bold;
                               white-space:nowrap; }
  .org-info-js_search-highlight {background-color:#ffff00; color:#000000;
                                 font-weight:bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>

</head>
<body>
<div id="content">

<h1 class="title">CLJ-FOREX</h1>



<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1 Introduction </a>
<ul>
<li><a href="#sec-1_1">1.1 What is forex? </a></li>
<li><a href="#sec-1_2">1.2 What is clj-forex? </a></li>
<li><a href="#sec-1_3">1.3 The Difference </a></li>
<li><a href="#sec-1_4">1.4 Where's the code?? </a></li>
</ul>
</li>
<li><a href="#sec-2">2 Development Tools </a></li>
<li><a href="#sec-3">3 From Ideas to Implementation - Metatrader Backend </a></li>
<li><a href="#sec-4">4 Code </a>
<ul>
<li><a href="#sec-4_1">4.1 Backend </a>
<ul>
<li><a href="#sec-4_1_1">4.1.1 MQL Socket Service </a></li>
</ul>
</li>
<li><a href="#sec-4_2">4.2 Module </a>
<ul>
<li><a href="#sec-4_2_1">4.2.1 Account </a></li>
<li><a href="#sec-4_2_2">4.2.2 Ea </a></li>
<li><a href="#sec-4_2_3">4.2.3 Error </a></li>
<li><a href="#sec-4_2_4">4.2.4 Indicator </a></li>
</ul>
</li>
<li><a href="#sec-4_3">4.3 Util </a>
<ul>
<li><a href="#sec-4_3_1">4.3.1 General </a></li>
<li><a href="#sec-4_3_2">4.3.2 Log </a></li>
<li><a href="#sec-4_3_3">4.3.3 Spawn </a></li>
<li><a href="#sec-4_3_4">4.3.4 ZMQ </a></li>
<li><a href="#sec-4_3_5">4.3.5 Devel </a></li>
</ul>
</li>
<li><a href="#sec-4_4">4.4 User </a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Introduction </h2>
<div class="outline-text-2" id="text-1">


</div>

<div id="outline-container-1_1" class="outline-3">
<h3 id="sec-1_1"><span class="section-number-3">1.1</span> What is forex? </h3>
<div class="outline-text-3" id="text-1_1">

<p>Forex is a currency trading market. But you probably know all about forex, since you're here! If not, read up on it! <br/>
</p><ul>
<li>
<a href="http://en.wikipedia.org/wiki/Foreign_exchange_market">Wiki article - OK</a>
</li>
<li>
<a href="http://www.fxcm.com/metatrader.jsp">FXCM Retail Broker Free Metatarder Terminal -  get demo account and see what forex trading is first hand!</a>
</li>
</ul>


</div>

</div>

<div id="outline-container-1_2" class="outline-3">
<h3 id="sec-1_2"><span class="section-number-3">1.2</span> What is clj-forex? </h3>
<div class="outline-text-3" id="text-1_2">

<p>Clj-forex is an in progress effort to create a non-graphical backend to various forex trading backends. Right now Metatrader is the focus. 
The ultimate goal of clj-forex is to create a robust library to allow the creation of EA (expert advisors) in the scripting language clojure. Expert advisors
are programs which automatically trade the market, performing sell/buy orderes, changing stoplosses, using technical indicators, etc. They are useful for
both automating parts of manual trading systems (performing trailing stops, expiration of market orders) and also for full out automated trading.
</p>
<p>
Indicators will be calculated java side using price bars retrieved from the backends. Integration of indicator data to various gui backends (i.e. at this time,
Metatrader) will be supported. The only purpose of the forex backend is to allow access to spreads, current price, ability to buy/sell, etc. 
</p></div>

</div>

<div id="outline-container-1_3" class="outline-3">
<h3 id="sec-1_3"><span class="section-number-3">1.3</span> The Difference </h3>
<div class="outline-text-3" id="text-1_3">

<p>Im not sure why noone has done this before, but integration of a scripting language to create eas is, in my opinion, vital. 
Integration of a lisp-like dialect, like clojure, will allow much more rapid creation and prototyping of eas. 
This combined with easy access to any java library (clojure is implemented on the java virtual machine) makes for a winning combination! 
Things like neural networks, database, and other such ‘advanced’ concepts can now be much more easily integrated than if we had used <a href="http://book.mql4.com/">mql4</a>.
</p>
<p>
Its like an artist! Give an artist more efficient tools in the toolbox and who knows what can be created! [And clojure is fun to learn anyways!]
</p></div>

</div>

<div id="outline-container-1_4" class="outline-3">
<h3 id="sec-1_4"><span class="section-number-3">1.4</span> Where's the code?? </h3>
<div class="outline-text-3" id="text-1_4">

<p>This file is the code (clojure, anyways). The code is untangled using the
keystroke C-c C-v t in emacs when this file is open. While currently most
of the code is simply in the Code section, it will all eventually be explained
in the <a href="http://groups.google.com/group/clojure/browse_thread/thread/664a1d305f32ab90">literate programming</a> manner.
</p></div>
</div>

</div>

<div id="outline-container-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Development Tools </h2>
<div class="outline-text-2" id="text-2">

<p>org-mode in emacs + babel is used. Currently code is one ns per one code block
format. Therefore, i use the below code, along with the latest git repository
for org-mode (needed!). I then hit f8 to detangle all my changes to my org file.
f9 can be used to jump from source code to location in org file. 
</p>


<pre class="src src-emacs-lisp">(<span style="color: #a020f0;">defvar</span> <span style="color: #a0522d;">clj-forex-file</span> <span style="color: #8b2252;">"/home/seth/Dropbox/.rep/clj-forex/clj-forex.org"</span>)
(<span style="color: #a020f0;">defvar</span>  <span style="color: #a0522d;">org-bracket-link-analytic-regexp</span>)
(setq org-bracket-link-analytic-regexp 
        (concat <span style="color: #8b2252;">";;[ ]*"</span>
         <span style="color: #8b2252;">"\\[\\["</span>
         <span style="color: #8b2252;">"</span><span style="color: #8b2252; font-weight: bold;">\\</span><span style="color: #8b2252; font-weight: bold;">(</span><span style="color: #8b2252; font-weight: bold;">\\</span><span style="color: #8b2252; font-weight: bold;">(</span><span style="color: #8b2252;">"</span> (mapconcat 'regexp-quote org-link-types <span style="color: #8b2252;">"</span><span style="color: #8b2252; font-weight: bold;">\\</span><span style="color: #8b2252; font-weight: bold;">|</span><span style="color: #8b2252;">"</span>) <span style="color: #8b2252;">"</span><span style="color: #8b2252; font-weight: bold;">\\</span><span style="color: #8b2252; font-weight: bold;">)</span><span style="color: #8b2252;">:</span><span style="color: #8b2252; font-weight: bold;">\\</span><span style="color: #8b2252; font-weight: bold;">)</span><span style="color: #8b2252;">?"</span>
         <span style="color: #8b2252;">"</span><span style="color: #8b2252; font-weight: bold;">\\</span><span style="color: #8b2252; font-weight: bold;">(</span><span style="color: #8b2252;">[</span><span style="color: #8b2252;">^</span><span style="color: #8b2252;">]]+</span><span style="color: #8b2252; font-weight: bold;">\\</span><span style="color: #8b2252; font-weight: bold;">)</span><span style="color: #8b2252;">"</span>
         <span style="color: #8b2252;">"\\]"</span>
         <span style="color: #8b2252;">"</span><span style="color: #8b2252; font-weight: bold;">\\</span><span style="color: #8b2252; font-weight: bold;">(</span><span style="color: #8b2252;">\\["</span> <span style="color: #8b2252;">"</span><span style="color: #8b2252; font-weight: bold;">\\</span><span style="color: #8b2252; font-weight: bold;">(</span><span style="color: #8b2252;">[</span><span style="color: #8b2252;">^</span><span style="color: #8b2252;">]]+</span><span style="color: #8b2252; font-weight: bold;">\\</span><span style="color: #8b2252; font-weight: bold;">)</span><span style="color: #8b2252;">"</span> <span style="color: #8b2252;">"\\]</span><span style="color: #8b2252; font-weight: bold;">\\</span><span style="color: #8b2252; font-weight: bold;">)</span><span style="color: #8b2252;">?"</span>
         <span style="color: #8b2252;">"\\]"</span>
 ))

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">with-file</span> (file <span style="color: #228b22;">&amp;rest</span> body)
  <span style="color: #8b2252;">"open up file in a buffer, and set current buffer to it"</span>
  `(<span style="color: #a020f0;">with-current-buffer</span> (find-file-noselect ,file t) ,@body))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">out-files</span> (org-file)
  (<span style="color: #a020f0;">let</span> (args)
    (org-babel-map-src-blocks org-file
      (<span style="color: #a020f0;">let</span> ((tangle-file (<span style="color: #a020f0;">with-temp-buffer</span>
                           (insert header-args)
                           (goto-char (point-min))
                           (<span style="color: #a020f0;">if</span> (re-search-forward <span style="color: #8b2252;">":tangle[ ]+</span><span style="color: #8b2252; font-weight: bold;">\\</span><span style="color: #8b2252; font-weight: bold;">(</span><span style="color: #8b2252;">[</span><span style="color: #8b2252;">^</span><span style="color: #8b2252;"> ]+</span><span style="color: #8b2252; font-weight: bold;">\\</span><span style="color: #8b2252; font-weight: bold;">)</span><span style="color: #8b2252;">"</span> nil t)
                               (match-string 1)
                             nil))))
        (<span style="color: #a020f0;">when</span> tangle-file (push tangle-file args))))
    args))

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">with-cd</span> (dir <span style="color: #228b22;">&amp;rest</span> body)
  (<span style="color: #a020f0;">let</span> ((current (gensym)))
    `(<span style="color: #a020f0;">let</span> ((,current default-directory))
       (cd ,dir)
       (<span style="color: #a020f0;">unwind-protect</span> (<span style="color: #a020f0;">progn</span> ,@body) (cd default-directory)))))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">detangle</span> ()
  (interactive)
  (<span style="color: #a020f0;">save-excursion</span>
    (<span style="color: #a020f0;">let*</span> ((org-file clj-forex-file)
           (out (out-files org-file))
           (amount 0))
      (with-cd (file-name-directory org-file)
               (<span style="color: #a020f0;">dolist</span> (file out)
                 (with-file
                  file
                  (goto-char (truncate (/ (+ (point-min) (point-max)) 2)))       
                  (incf amount (org-babel-detangle)))))
      (message <span style="color: #8b2252;">"Detangled %s source blocks"</span> amount))))
(global-set-key (kbd <span style="color: #8b2252;">"&lt;f8&gt;"</span>) 'detangle)
(global-set-key (kbd <span style="color: #8b2252;">"&lt;f9&gt;"</span>) 'org-babel-tangle-jump-to-org)
(setq org-src-fontify-natively t)
</pre>



<p>
Given the tangled output of the source files, which basically tags the
code so that it can detangle it and jump back to the org file, we can
technically work in something other than emacs if we have a clojure tool
to detangle and tangle. However, this is not yet implemented. Also, it is planned
to give noweb support for babel so that i can break up the blocks.
</p>
<p>
Yes, currently it is not very development start friendly. That will change!
</p></div>

</div>

<div id="outline-container-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> From Ideas to Implementation - Metatrader Backend </h2>
<div class="outline-text-2" id="text-3">

</div>

</div>

<div id="outline-container-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Code </h2>
<div class="outline-text-2" id="text-4">


</div>

<div id="outline-container-4_1" class="outline-3">
<h3 id="sec-4_1"><span class="section-number-3">4.1</span> Backend </h3>
<div class="outline-text-3" id="text-4_1">


</div>

<div id="outline-container-4_1_1" class="outline-4">
<h4 id="sec-4_1_1"><span class="section-number-4">4.1.1</span> MQL Socket Service </h4>
<div class="outline-text-4" id="text-4_1_1">




<div class="org-src-container"><label class="org-src-name">mql-socket-service()</label><pre class="src src-clojure">
<span style="color: #b22222;">;;</span><span style="color: #b22222;">forex.backend.mql.socket-service: provide background sockets which allow us to connect with metatrader. Provides functions to interact with the background socket
</span>
<span style="color: #b22222;">;;</span><span style="color: #b22222;">todo: bug with stopping all and then stopping again! so bug with stop..
</span>(<span style="color: #a020f0;">ns</span> forex.backend.mql.socket-service   
  (<span style="color: #7a378b;">:require</span>
   [utils.fiber.mbox <span style="color: #7a378b;">:as</span> m]
   [clojure.contrib.logging <span style="color: #7a378b;">:as</span> l])
  (<span style="color: #7a378b;">:use</span>
   emacs 
   forex.util.general forex.util.zmq forex.util.log
   forex.util.spawn utils.general))

<span style="color: #b22222;">;;</span><span style="color: #b22222;">TODO: 3ms or so per request, a little slow...
</span><span style="color: #b22222;">;;</span><span style="color: #b22222;">also, unfortunately, if we add more servers, speed doesn't increase linearly. so the bottleneck is in the clojure code ... a better designed socket service should really be made.
</span><span style="color: #b22222;">;; </span><span style="color: #b22222;">in addition, if servers drop out, we will be waiting forever for them. this is bad.
</span>
(<span style="color: #a020f0;">defvar</span> <span style="color: #0000ff;">mql-socket-recv-address</span> <span style="color: #8b2252;">"tcp://127.0.0.1:3000"</span>)
(<span style="color: #a020f0;">defvar</span> <span style="color: #0000ff;">mql-socket-send-address</span> <span style="color: #8b2252;">"tcp://127.0.0.1:3005"</span>)
(<span style="color: #a020f0;">defvar</span> <span style="color: #0000ff;">mql-socket-pub-address</span> <span style="color: #8b2252;">"tcp://127.0.0.1:3010"</span>)

<span style="color: #b22222;">;;</span><span style="color: #b22222;">utils
</span>(<span style="color: #a020f0;">defonce-</span> <span style="color: #0000ff;">*msg-id*</span> (<span style="color: #7a378b;">atom</span> 0))
(<span style="color: #a020f0;">defn-</span> <span style="color: #0000ff;">msg-id</span> []
  (<span style="color: #7a378b;">str</span> (<span style="color: #7a378b;">swap!</span> *msg-id* inc)))
(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">catch-unexpected</span> [&amp; body]
  `(<span style="color: #a020f0;">try</span> (<span style="color: #a020f0;">do</span> ~@body)
        (<span style="color: #a020f0;">catch</span> Exception e# (.printStackTrace e#) (warn e#))))

<span style="color: #b22222;">;;</span><span style="color: #b22222;">socket service
</span><span style="color: #b22222;">;;</span><span style="color: #b22222;">TODO: send id then message
</span>(<span style="color: #a020f0;">defn-</span> <span style="color: #0000ff;">mql-recv</span> [ids msg] 
  (catch-unexpected   
   (<span style="color: #a020f0;">let</span> [key (<span style="color: #7a378b;">first</span> msg)
         msg-ask (@ids key)]
     (<span style="color: #a020f0;">if-not</span> (<span style="color: #7a378b;">satisfies?</span> PWait msg-ask)
       (warn <span style="color: #8b2252;">"Ignoring invalid msg: %s"</span> msg)
       (<span style="color: #a020f0;">do</span> 
         (give msg-ask (<span style="color: #7a378b;">second</span> msg))
         (<span style="color: #7a378b;">swap!</span> ids dissoc key))))))

(<span style="color: #a020f0;">defn-</span> <span style="color: #0000ff;">socket-service-match</span> [events ids send receive]
  (match  
   (<span style="color: #7a378b;">first</span> events)
   [local <span style="color: #8b2252;">"STOP"</span>] (<span style="color: #a020f0;">do</span> (info <span style="color: #8b2252;">"closing ..."</span>) <span style="color: #8b2252;">"stop"</span>)  
   [local [<span style="color: #8b2252;">"REQUEST"</span> ?msg ?askin]]  
   (<span style="color: #a020f0;">if-not</span> (<span style="color: #7a378b;">satisfies?</span>  PWait askin)
     (warn <span style="color: #8b2252;">"Ignoring invalid REQUEST which does not contain a PWait argument %s %s"</span> 
           msg askin) 
     (<span style="color: #a020f0;">let</span> [id (msg-id)  
           result  (.snd send (<span style="color: #7a378b;">str</span> id <span style="color: #8b2252;">" "</span> msg) +noblock+)]
       (<span style="color: #a020f0;">if-not</span> result  
         (<span style="color: #a020f0;">do</span>  
           (warn <span style="color: #8b2252;">"failed to queue request %s: are any metatrader scripts alive?"</span>
                 msg)
           (catch-unexpected
            (give askin (Exception. <span style="color: #8b2252;">"socket service down"</span>))))
         (<span style="color: #7a378b;">swap!</span> ids assoc id askin))))  
   [receive ?msg] (mql-recv ids msg) 
   ?msg (warn <span style="color: #8b2252;">"Ignoring invalid message %s"</span> msg)))

<span style="color: #b22222;">;;</span><span style="color: #b22222;">TODO: weird bugwhen stopping everything with an ea.
</span>
(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">spawn-mql-socket-service</span>
  []  
  (debugging
   <span style="color: #8b2252;">"MQL Socket Service: "</span> 
   (<span style="color: #a020f0;">let</span> [ids (<span style="color: #7a378b;">atom</span> {})]
     {<span style="color: #7a378b;">:pid</span> 
      (spawn-log  
       #(<span style="color: #a020f0;">with-open</span> [send (<span style="color: #a020f0;">doto</span> (new-socket +push+)
                           (.bind mql-socket-send-address))
                    receive (<span style="color: #a020f0;">doto</span> (new-socket +pull+)
                              (.bind mql-socket-recv-address))]
          (<span style="color: #a020f0;">loop</span> [events (event-seq [receive local])]
            (<span style="color: #a020f0;">when-not</span> (<span style="color: #7a378b;">=</span> <span style="color: #8b2252;">"stop"</span> (socket-service-match events ids send receive))
              (<span style="color: #a020f0;">recur</span> (<span style="color: #7a378b;">rest</span> events))))))}))) 

<span style="color: #b22222;">;;</span><span style="color: #b22222;">global socket service
</span>(<span style="color: #a020f0;">defonce-</span> <span style="color: #0000ff;">*s*</span> (<span style="color: #7a378b;">atom</span> nil))
(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">alive?</span> []
  (pid? (<span style="color: #7a378b;">:pid</span> @*s*))) 
(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">start</span> []
  (<span style="color: #a020f0;">if</span> (alive?)
    (warn <span style="color: #8b2252;">"mql socket is already alive!"</span>)
    (<span style="color: #7a378b;">reset!</span> *s* (spawn-mql-socket-service))))
(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">stop</span> []
  (<span style="color: #a020f0;">if</span> (alive?)
    (! (<span style="color: #7a378b;">:pid</span> @*s*) <span style="color: #8b2252;">"STOP"</span>)
    (warn <span style="color: #8b2252;">"mql socket service is already stopped"</span>)))

<span style="color: #b22222;">;;</span><span style="color: #b22222;">interact with mql 
</span>(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">request</span> [askin msg]
  (<span style="color: #7a378b;">io!</span>
   (<span style="color: #a020f0;">if</span> (pid? (<span style="color: #7a378b;">:pid</span> @*s*)) 
     (! (<span style="color: #7a378b;">:pid</span> @*s*) [<span style="color: #8b2252;">"REQUEST"</span> msg askin])
     (throwf <span style="color: #8b2252;">"mql socket service is not alive"</span>))))

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">receive</span>
  ([msg] (receive msg nil))
  ([msg timeout]
     (<span style="color: #a020f0;">let</span> [askin (beg)]
       (request askin msg)
       (<span style="color: #a020f0;">let</span> [result (<span style="color: #a020f0;">if</span> (wait-for askin timeout) @askin)]
         (<span style="color: #a020f0;">cond</span>
          (<span style="color: #7a378b;">instance?</span> Exception result) (<span style="color: #a020f0;">throw</span> result)
          result result
          true (throwf <span style="color: #8b2252;">"invalid result received %s"</span> result))))))
</pre></div>


</div>
</div>

</div>

<div id="outline-container-4_2" class="outline-3">
<h3 id="sec-4_2"><span class="section-number-3">4.2</span> Module </h3>
<div class="outline-text-3" id="text-4_2">


</div>

<div id="outline-container-4_2_1" class="outline-4">
<h4 id="sec-4_2_1"><span class="section-number-4">4.2.1</span> Account </h4>
<div class="outline-text-4" id="text-4_2_1">




<div class="org-src-container"><label class="org-src-name">account-core()</label><pre class="src src-clojure">
<span style="color: #b22222;">;;</span><span style="color: #b22222;">forex.module.order.core - interface with mql backend
</span>
(<span style="color: #a020f0;">ns</span> forex.module.account.core
  (<span style="color: #7a378b;">:use</span> utils.general emacs utils.fiber.spawn
        forex.util.general
        forex.module.error.common))

(<span style="color: #a020f0;">def-</span> <span style="color: #0000ff;">order</span>
  {<span style="color: #7a378b;">:buy</span> 0 <span style="color: #7a378b;">:sell</span> 1 <span style="color: #7a378b;">:buy-limit</span> 2 <span style="color: #7a378b;">:sell-limit</span> 3 <span style="color: #7a378b;">:buy-stop</span> 4 <span style="color: #7a378b;">:sell-stop</span> 5})

(<span style="color: #a020f0;">def-</span> <span style="color: #0000ff;">color</span>
  {<span style="color: #7a378b;">:red</span> 230 <span style="color: #7a378b;">:yellow</span> 65535 <span style="color: #7a378b;">:green</span> 65280 <span style="color: #7a378b;">:blue</span> 13749760
   <span style="color: #7a378b;">:purple</span>  16711935 <span style="color: #7a378b;">:white</span> 16777215 <span style="color: #7a378b;">:black</span> 0})

(<span style="color: #a020f0;">defn-</span> <span style="color: #0000ff;">get!</span> [hash key]
  (<span style="color: #a020f0;">if-let</span> [it (<span style="color: #7a378b;">hash</span> key)]
    it
    (throwf <span style="color: #8b2252;">"invalid key %s in hash %s"</span> key hash)))

<span style="color: #b22222;">;;</span><span style="color: #b22222;">the below can throw errors - how to handle this? 
</span>(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">order-modify</span>
  ([ticket price sl tp]
     (order-modify ticket price sl tp <span style="color: #7a378b;">:blue</span>))
  ([ticket price sl tp color_of]
     (receive
      (<span style="color: #7a378b;">format</span> <span style="color: #8b2252;">"OrderModify %s %s %s %s %s"</span>
              ticket price sl tp (get! color color_of)))
     <span style="color: #b22222;">;;</span><span style="color: #b22222;">{:id ticket :price price :sl sl :tp tp :color color_of}
</span>     ))

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">order-send</span>
  ([symbol cmd volume price] (order-send symbol cmd volume price 0 0))
  ([symbol cmd volume price sl tp] (order-send symbol cmd volume price sl tp 3))
  ([symbol cmd volume price sl tp slip]
     (receive
      (<span style="color: #7a378b;">format</span> <span style="color: #8b2252;">"OrderSend %s %s %s %s %s %s %s"</span>
              symbol (get! order cmd)
              volume price slip sl tp))))

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">order-close-time</span> [ticket]
  (receive-int (<span style="color: #7a378b;">format</span> <span style="color: #8b2252;">"OrderCloseTime %s"</span> ticket)))

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">order-close</span> [ticket lots price slippage color_of]
  (receive  
   (<span style="color: #7a378b;">format</span> <span style="color: #8b2252;">"OrderClose %s %s %s %s %s"</span>
           ticket lots price slippage (get! color color_of))))
(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">order-delete</span> [ticket]
  (receive (<span style="color: #7a378b;">format</span> <span style="color: #8b2252;">"OrderDelete %s"</span> ticket)))

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">market-info</span> [symbol type]
  (receive-double (<span style="color: #7a378b;">format</span> <span style="color: #8b2252;">"MarketInfo %s %s"</span> symbol type)))

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">order-close-time</span> [ticket]
  (receive-double (<span style="color: #7a378b;">format</span> <span style="color: #8b2252;">"OrderCloseTime %s"</span> ticket)))

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">order-type</span> [ticket]
  (receive-double (<span style="color: #7a378b;">format</span> <span style="color: #8b2252;">"OrderType %s"</span> ticket)))

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">order-lots</span> [ticket]
  (receive-double (<span style="color: #7a378b;">format</span> <span style="color: #8b2252;">"OrderLots %s"</span> ticket)))
</pre></div>



<div class="org-src-container"><label class="org-src-name">account-common()</label><pre class="src src-clojure">
<span style="color: #b22222;">;;</span><span style="color: #b22222;">TODO: unit test everything
</span>(<span style="color: #a020f0;">ns</span> forex.module.account.common
  (<span style="color: #7a378b;">:use</span> utils.general emacs  
        forex.util.general
        forex.module.error.common
        forex.module.indicator.common)
  (<span style="color: #7a378b;">:require</span> forex.module.error.common [forex.module.error.common <span style="color: #7a378b;">:as</span> err])
  (<span style="color: #7a378b;">:require</span>  [forex.module.account.core <span style="color: #7a378b;">:as</span> core]))

(<span style="color: #a020f0;">defn-</span> <span style="color: #0000ff;">&gt;?</span> [a] (<span style="color: #a020f0;">and</span> (<span style="color: #7a378b;">number?</span> a) (<span style="color: #7a378b;">&gt;=</span> a 0)))

(<span style="color: #a020f0;">defmacro-</span> <span style="color: #0000ff;">default</span> [&amp; body] 
  `(<span style="color: #a020f0;">binding</span> [*default* @~#'err/*er*]
     ~@body))

<span style="color: #b22222;">;;</span><span style="color: #b22222;">TODO: do we need all of these assertions?
</span>(<span style="color: #a020f0;">def-</span> <span style="color: #0000ff;">value-to-order-type</span>
  {0 <span style="color: #7a378b;">:buy</span> 1 <span style="color: #7a378b;">:sell</span> 2 <span style="color: #7a378b;">:buy-limit</span>
   3 <span style="color: #7a378b;">:sell-limit</span> 4 <span style="color: #7a378b;">:buy-stop</span>
   5 <span style="color: #7a378b;">:sell-stop</span>}) 

(<span style="color: #a020f0;">defprotocol</span> <span style="color: #0000ff;">POrder</span>
  (order-close-time [this])
  (order-type [this])
  (delete! [this] )
  (close! [this] [this new-lots])
  (modify! [this sl-tp-map])
  (order! [this])
  (open? [this]) (close? [this])
  (order? [this]) 
  (market? [this]) (entry? [this]))

(<span style="color: #a020f0;">defn-</span> <span style="color: #0000ff;">order-close-time*</span> [{id <span style="color: #7a378b;">:id</span>}]
  (<span style="color: #228b22;">is</span> (<span style="color: #7a378b;">string?</span> id))
  <span style="color: #b22222;">;;</span><span style="color: #b22222;">we dont need to know mql4 error codes for order close time
</span>  (aif (core/order-close-time id) it -1))
(<span style="color: #a020f0;">defn-</span> <span style="color: #0000ff;">order-type*</span>  [order]
  (<span style="color: #228b22;">is</span> (<span style="color: #7a378b;">string?</span> (<span style="color: #7a378b;">:id</span> order)))
  (default
    (aif (core/order-type (<span style="color: #7a378b;">:id</span> order))
         (value-to-order-type (<span style="color: #7a378b;">int</span> it)))))

(<span style="color: #a020f0;">defn-</span> <span style="color: #0000ff;">delete!*</span> [{id <span style="color: #7a378b;">:id</span> lots <span style="color: #7a378b;">:lots</span> <span style="color: #7a378b;">:as</span> o}]
  (<span style="color: #a020f0;">if-not</span> (<span style="color: #7a378b;">=</span> lots 0)
    (aif (core/order-delete id) (<span style="color: #7a378b;">merge</span> o {<span style="color: #7a378b;">:lots</span> 0}) it)
    o))

(<span style="color: #a020f0;">defn-</span> <span style="color: #0000ff;">close!*</span>
  ([o] (close! o 0))
  ([{<span style="color: #7a378b;">:keys</span> [price lots slip id] <span style="color: #7a378b;">:as</span> order} new-lots]
     (<span style="color: #228b22;">is</span> (<span style="color: #a020f0;">and</span> (<span style="color: #7a378b;">string?</span> id) (<span style="color: #a020f0;">and</span> price (<span style="color: #7a378b;">pos?</span> price))
              (<span style="color: #a020f0;">and</span> (<span style="color: #7a378b;">number?</span> lots) (<span style="color: #7a378b;">&gt;=</span> lots 0))))
     (<span style="color: #228b22;">is</span> (<span style="color: #7a378b;">&gt;=</span> (<span style="color: #7a378b;">-</span> lots new-lots) 0))
     (<span style="color: #a020f0;">if-not</span> (<span style="color: #7a378b;">=</span> new-lots lots)
       (aif (core/order-close id (<span style="color: #7a378b;">-</span> lots new-lots) price slip <span style="color: #7a378b;">:blue</span>)
            (<span style="color: #7a378b;">merge</span> order {<span style="color: #7a378b;">:lots</span> new-lots})
            it)
       order)))

(<span style="color: #a020f0;">defn-</span> <span style="color: #0000ff;">modify!*</span> [order {<span style="color: #7a378b;">:keys</span> [sl tp price]}]
  (<span style="color: #a020f0;">let</span> [sl (<span style="color: #a020f0;">or</span> sl (<span style="color: #7a378b;">:sl</span> order))
        tp (<span style="color: #a020f0;">or</span> tp (<span style="color: #7a378b;">:tp</span> order))
        price (<span style="color: #a020f0;">or</span> price (<span style="color: #7a378b;">:price</span> order))]
    (<span style="color: #228b22;">is</span> (<span style="color: #a020f0;">and</span> sl tp price
             (&gt;? sl) (&gt;? tp) (<span style="color: #7a378b;">pos?</span> price)))
    (<span style="color: #a020f0;">if-not</span> (<span style="color: #a020f0;">and</span> (<span style="color: #7a378b;">=</span> sl (<span style="color: #7a378b;">:sl</span> order))
                 (<span style="color: #7a378b;">=</span> tp (<span style="color: #7a378b;">:tp</span> order)))
      (aif (core/order-modify (<span style="color: #7a378b;">:id</span> order) price sl tp)
           (<span style="color: #7a378b;">merge</span> order {<span style="color: #7a378b;">:sl</span> sl <span style="color: #7a378b;">:tp</span> tp <span style="color: #7a378b;">:price</span> price})
           it)
      order)))

<span style="color: #b22222;">;;</span><span style="color: #b22222;">TOOD: how do we get map with defaults?
</span>(<span style="color: #a020f0;">defn-</span> <span style="color: #0000ff;">verify-order</span> [{<span style="color: #7a378b;">:keys</span> [slip symbol type price tp sl lots]
                      <span style="color: #7a378b;">:or</span> {slip 3 sl 0 tp 0}}]
  (<span style="color: #228b22;">is</span> (<span style="color: #a020f0;">and</span> (<span style="color: #7a378b;">number?</span> slip) (<span style="color: #7a378b;">&gt;</span> slip 0) (<span style="color: #7a378b;">integer?</span> slip))
      <span style="color: #8b2252;">"invalid order slip %s"</span> slip)
  (<span style="color: #228b22;">is</span> (<span style="color: #a020f0;">and</span> (<span style="color: #7a378b;">keyword?</span> type) (<span style="color: #7a378b;">number?</span> lots)
           (<span style="color: #7a378b;">number?</span> tp) (<span style="color: #7a378b;">number?</span> sl) (<span style="color: #7a378b;">number?</span> price))) 
  (<span style="color: #228b22;">is</span> (<span style="color: #a020f0;">and</span> (<span style="color: #7a378b;">string?</span> symbol) (<span style="color: #7a378b;">&gt;</span> lots 0)
           (<span style="color: #7a378b;">&gt;=</span> tp 0) (<span style="color: #7a378b;">&gt;=</span> sl 0) (<span style="color: #7a378b;">&gt;=</span> price 0)))  
  (<span style="color: #a020f0;">cond</span>
    (<span style="color: #a020f0;">or</span> (<span style="color: #7a378b;">=</span> type <span style="color: #7a378b;">:sell</span>) (<span style="color: #7a378b;">=</span> type <span style="color: #7a378b;">:sell-limit</span>) (<span style="color: #7a378b;">=</span> type <span style="color: #7a378b;">:sell-stop</span>))
    (<span style="color: #228b22;">is</span> (<span style="color: #a020f0;">or</span> (<span style="color: #a020f0;">and</span> (zero? sl) (zero? tp))
            (<span style="color: #a020f0;">and</span> (zero? sl) tp (<span style="color: #7a378b;">&lt;</span> tp price))
            (<span style="color: #a020f0;">and</span> (zero? tp) sl (<span style="color: #7a378b;">&gt;</span> sl price))
            (<span style="color: #a020f0;">and</span> (<span style="color: #7a378b;">&lt;</span> tp sl) (<span style="color: #7a378b;">&lt;</span> tp price) (<span style="color: #7a378b;">&gt;</span> sl price)))
        <span style="color: #8b2252;">"invalid %s order with sl/tp %s/%s with price of %s"</span> type sl tp price)
    (<span style="color: #a020f0;">or</span> (<span style="color: #7a378b;">=</span> type <span style="color: #7a378b;">:buy</span>) (<span style="color: #7a378b;">=</span> type <span style="color: #7a378b;">:buy-limit</span>) (<span style="color: #7a378b;">=</span> type <span style="color: #7a378b;">:buy-stop</span>))
    (<span style="color: #228b22;">is</span> (<span style="color: #a020f0;">or</span> (<span style="color: #a020f0;">and</span> (zero? sl) (zero? tp))
            (<span style="color: #a020f0;">and</span> (zero? sl) tp (<span style="color: #7a378b;">&gt;</span> tp price))
            (<span style="color: #a020f0;">and</span> (zero? tp) sl (<span style="color: #7a378b;">&lt;</span> sl price))
            (<span style="color: #a020f0;">and</span> (<span style="color: #7a378b;">&gt;</span> tp sl) (<span style="color: #7a378b;">&gt;</span> tp price) (<span style="color: #7a378b;">&lt;</span> sl price)))
        <span style="color: #8b2252;">"invalid %s order with sl/tp %s/%s with price of %s"</span> type sl tp price)
    true (throwf <span style="color: #8b2252;">"invalid %s order with sl/tp %s/%s with price of %s"</span>
                 type sl tp price))) 
<span style="color: #b22222;">;;</span><span style="color: #b22222;">TODO: change to make reliable and to work for ECN brokers and such
</span><span style="color: #b22222;">;;</span><span style="color: #b22222;">see http://forum.mql4.com/36608
</span>(<span style="color: #a020f0;">defn-</span> <span style="color: #0000ff;">order!*</span> [{<span style="color: #7a378b;">:keys</span> [symbol type price tp sl lots slip]
                        <span style="color: #7a378b;">:as</span> order <span style="color: #7a378b;">:or</span> {symbol (env <span style="color: #7a378b;">:symbol</span>) slip 3 sl 0 tp 0}}]
  (verify-order (<span style="color: #7a378b;">merge</span> {<span style="color: #7a378b;">:symbol</span> symbol} order))
  (aif (core/order-send symbol type lots price 0 0 slip)
       (<span style="color: #a020f0;">let</span> [o (<span style="color: #7a378b;">merge</span> {<span style="color: #7a378b;">:slip</span> slip <span style="color: #7a378b;">:symbol</span> symbol} (<span style="color: #7a378b;">merge</span> order {<span style="color: #7a378b;">:id</span> it}))]
         <span style="color: #b22222;">;;</span><span style="color: #b22222;">now, use modify to change sl and tp
</span>         (aif (modify!* o {<span style="color: #7a378b;">:sl</span> sl <span style="color: #7a378b;">:tp</span> tp})
              (<span style="color: #7a378b;">merge</span> {<span style="color: #7a378b;">:sl</span> sl <span style="color: #7a378b;">:tp</span> tp} o)
              o))
       it))

(<span style="color: #a020f0;">defn-</span> <span style="color: #0000ff;">open?*</span> [order] 
  (default (<span style="color: #7a378b;">=</span> (order-close-time order) 0)))
(<span style="color: #a020f0;">defn-</span> <span style="color: #0000ff;">close?*</span> [order]
  (<span style="color: #7a378b;">not</span> (open? order)))
(<span style="color: #a020f0;">defn-</span> <span style="color: #0000ff;">order?*</span> [order]
  (<span style="color: #7a378b;">not</span> (<span style="color: #7a378b;">nil?</span> (order-type order))))   
(<span style="color: #a020f0;">defn-</span> <span style="color: #0000ff;">market?*</span>
  <span style="color: #8b2252;">"determine if order is market order"</span>
  [order]
  (<span style="color: #a020f0;">let</span> [type (order-type order)]
    (<span style="color: #a020f0;">or</span> (<span style="color: #7a378b;">=</span> type <span style="color: #7a378b;">:sell</span>) (<span style="color: #7a378b;">=</span> type <span style="color: #7a378b;">:buy</span>)))) 
(<span style="color: #a020f0;">defn-</span> <span style="color: #0000ff;">entry?*</span>
  <span style="color: #8b2252;">"determine if order is entry order"</span>
  [order]
  (<span style="color: #a020f0;">let</span> [type (order-type order)]
    (<span style="color: #a020f0;">and</span> type (<span style="color: #7a378b;">not</span> (<span style="color: #a020f0;">or</span> (<span style="color: #7a378b;">=</span> type <span style="color: #7a378b;">:sell</span>) (<span style="color: #7a378b;">=</span> type <span style="color: #7a378b;">:buy</span>))))))

(<span style="color: #7a378b;">extend</span> clojure.lang.IPersistentMap
  POrder {<span style="color: #7a378b;">:order-close-time</span> order-close-time*
          <span style="color: #7a378b;">:order-type</span> order-type*
          <span style="color: #7a378b;">:delete!</span> delete!*
          <span style="color: #7a378b;">:close!</span> close!*
          <span style="color: #7a378b;">:modify!</span> modify!*
          <span style="color: #7a378b;">:order!</span> order!*

          <span style="color: #7a378b;">:open?</span> open?*
          <span style="color: #7a378b;">:close?</span> close?*
          <span style="color: #7a378b;">:order?</span> order?*
          <span style="color: #7a378b;">:market?</span> market?*
          <span style="color: #7a378b;">:entry?</span> entry?*})

(<span style="color: #7a378b;">extend-type</span> forex.module.error.common.MqlError
  POrder
  (order! [this] this)
  (delete! [this] this)
  (close! [this] this)
  (modify! [this] this))

(<span style="color: #7a378b;">extend-type</span> forex.util.general.AtomHash <span style="color: #b22222;">;;</span><span style="color: #b22222;">clojure.lang.Atom
</span>  POrder
  (order-close-time [this] (order-close-time @this))
  (order-type [this] (order-type @this))
  (order! [this] (aif (order! @this) (<span style="color: #a020f0;">do</span> (<span style="color: #7a378b;">reset!</span> (.val this) it) this) it))
  (delete! [this] (aif (delete! @this) (<span style="color: #a020f0;">do</span> (<span style="color: #7a378b;">reset!</span> (.val this) it) this) it))
  (close!
   ([this new-amount] (aif (close! @this new-amount) (<span style="color: #a020f0;">do</span> (<span style="color: #7a378b;">reset!</span> (.val this) it) this) it))
   ([this] (close! this 0)))
  (modify! [this sl-tp] (aif (modify! @this sl-tp) (<span style="color: #a020f0;">do</span> (<span style="color: #7a378b;">reset!</span> (.val this) it) this) it))
  (open? [this] (open? @this))
  (close? [this] (<span style="color: #7a378b;">not</span> (open? @this)))
  (order? [this] (order? @this))
  (market? [this] (market? @this))
  (entry? [this] (entry? @this)))

<span style="color: #b22222;">;;;</span><span style="color: #b22222;">below is account
</span>
(<span style="color: #7a378b;">comment</span>
  (<span style="color: #a020f0;">defn-</span> <span style="color: #0000ff;">immigrate</span> [&amp; syms]
    (<span style="color: #a020f0;">let</span> [core-ns (<span style="color: #7a378b;">find-ns</span> 'forex.module.account.core)
          publics (<span style="color: #7a378b;">ns-publics</span> 'forex.module.account.core)]
      (on [s syms]
          (<span style="color: #a020f0;">let</span> [sym  (<span style="color: #7a378b;">symbol</span> (camel-to-dash s))]
            (<span style="color: #7a378b;">intern</span> *ns* sym (<span style="color: #7a378b;">var-get</span> (<span style="color: #7a378b;">intern</span> core-ns sym))))))))

<span style="color: #b22222;">;;</span><span style="color: #b22222;">account common
</span>(<span style="color: #a020f0;">defn-</span> <span style="color: #0000ff;">sym</span> [a] (<span style="color: #7a378b;">symbol</span> (camel-to-dash a)))
(<span style="color: #a020f0;">defmacro-</span> <span style="color: #0000ff;">single</span> [name] `(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">~</span>(sym name) [] (receive! ~name)))
(<span style="color: #a020f0;">defmacro-</span> <span style="color: #0000ff;">double-single</span> [name] `(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">~</span>(sym name) [] (receive-double! ~name)))
(<span style="color: #a020f0;">defmacro-</span> <span style="color: #0000ff;">singles</span> [&amp; names] `(<span style="color: #a020f0;">do</span> ~@(<span style="color: #7a378b;">map</span> (<span style="color: #7a378b;">fn</span> [a] `(single ~a)) names)))
(<span style="color: #a020f0;">defmacro-</span> <span style="color: #0000ff;">double-singles</span> [&amp; names] `(<span style="color: #a020f0;">do</span> ~@(<span style="color: #7a378b;">map</span> (<span style="color: #7a378b;">fn</span> [a] `(double-single ~a)) names)))

<span style="color: #b22222;">;;</span><span style="color: #b22222;">none of the below singles or double-singles should throw a mql error - therefore, it is a bug if they do
</span>(singles 
 <span style="color: #8b2252;">"AccountCurrency"</span>
 <span style="color: #8b2252;">"AccountCompany"</span>
 <span style="color: #8b2252;">"AccountServer"</span> 
 <span style="color: #8b2252;">"AccountName"</span>
 <span style="color: #8b2252;">"AccountNumber"</span>)

(double-singles
 <span style="color: #8b2252;">"AccountCredit"</span>
 <span style="color: #8b2252;">"AccountBalance"</span>
 <span style="color: #8b2252;">"AccountEquity"</span>
 <span style="color: #8b2252;">"AccountFreeMargin"</span>
 <span style="color: #8b2252;">"AccountLeverage"</span>
 <span style="color: #8b2252;">"AccountMargin"</span>
 <span style="color: #8b2252;">"AccountProfit"</span>
 <span style="color: #8b2252;">"OrdersTotal"</span>)
<span style="color: #b22222;">;;</span><span style="color: #b22222;">
</span>
(<span style="color: #a020f0;">defmacro-</span> <span style="color: #0000ff;">define-market-info</span> [&amp; args]
  `(<span style="color: #a020f0;">do</span> ~@(<span style="color: #7a378b;">map</span> (<span style="color: #7a378b;">fn</span> [[name num]]
                `(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">~</span>(symbolicate <span style="color: #8b2252;">"mode-"</span> name)
                   ([] (~(symbolicate <span style="color: #8b2252;">"mode-"</span> name) (env <span style="color: #7a378b;">:symbol</span>)))
                   ([symbol#]
                      (core/market-info symbol# ~num))))
              (group args))))

(define-market-info
  low 1
  high 2
  time 5
  bid 9
  ask 10
  point 11
  digits 12
  spread 13
  stoplevel 14
  lotsize 15
  tickvalue 16
  ticksize 17
  swaplong 18
  swapshort 19
  starting 20
  expiration 21
  trade-allowed 22
  minlot 23
  lotstep 24
  maxlot 25
  swaptype 26
  profitcalcmode 27
  margincalcmode 28
  margininit 29
  marginmaintenance 30
  marginhedged 31
  marginrequired 32
  freezelevel 33)

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">demo?</span> []
  (<span style="color: #a020f0;">if</span> (<span style="color: #7a378b;">re-find</span> #<span style="color: #8b2252;">"(?i)demo"</span> (account-server))
    true
    false))
</pre></div>


</div>

</div>

<div id="outline-container-4_2_2" class="outline-4">
<h4 id="sec-4_2_2"><span class="section-number-4">4.2.2</span> Ea </h4>
<div class="outline-text-4" id="text-4_2_2">




<div class="org-src-container"><label class="org-src-name">ea-common()</label><pre class="src src-clojure">
(<span style="color: #a020f0;">ns</span> forex.module.ea.common
  (<span style="color: #7a378b;">:use</span> utils.general forex.util.general
        utils.fiber.spawn clojure.contrib.core)
  (<span style="color: #7a378b;">:require</span> [clj-time.core <span style="color: #7a378b;">:as</span> t])
  (<span style="color: #7a378b;">:use</span>
   forex.util.log
   forex.module.error.common
   forex.module.indicator.common
   forex.module.account.common))
(<span style="color: #a020f0;">defn-</span> <span style="color: #0000ff;">get-fn</span> [a] (<span style="color: #a020f0;">if</span> (<span style="color: #7a378b;">var?</span> a) (<span style="color: #7a378b;">var-get</span> a) a))  
<span style="color: #b22222;">;;</span><span style="color: #b22222;">##ea implementation
</span>(<span style="color: #a020f0;">defonce</span> <span style="color: #0000ff;">*eas*</span> (<span style="color: #7a378b;">atom</span> []))
(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">every</span> [pred coll]
  (<span style="color: #a020f0;">if</span> (<span style="color: #7a378b;">empty?</span> coll)
    false
    (<span style="color: #a020f0;">loop</span> [a coll]
      (<span style="color: #a020f0;">if</span> (<span style="color: #7a378b;">empty?</span> a)
        true
        (<span style="color: #a020f0;">if</span> (<span style="color: #7a378b;">not</span> (pred (<span style="color: #7a378b;">first</span> a)))
          false
          (<span style="color: #a020f0;">recur</span> (<span style="color: #7a378b;">rest</span> a)))))))

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">query</span> [m]
  (<span style="color: #7a378b;">filter</span>
   (<span style="color: #7a378b;">fn</span> [ea]
     (<span style="color: #a020f0;">if</span> (every (<span style="color: #7a378b;">fn</span> [[key val]]
                  (<span style="color: #7a378b;">=</span> val (ea key)))
                m) 
       ea))
   @*eas*))
(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">alive?</span> [ea] (pid? (<span style="color: #7a378b;">:pid</span> ea)))

(<span style="color: #a020f0;">defmacro-</span> <span style="color: #0000ff;">catch-unexpected</span> [prefix &amp; body]
  `(<span style="color: #a020f0;">try</span> (<span style="color: #a020f0;">do</span> ~@body)
        (<span style="color: #a020f0;">catch</span> Exception e#
          (severe <span style="color: #8b2252;">"%s - caught unexpected error %s"</span> ~prefix e#))))

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">run-by-tick</span> [{<span style="color: #7a378b;">:keys</span> [symbol timeframe name deinit init start] <span style="color: #7a378b;">:as</span> ea}]
  (debugging
   (<span style="color: #7a378b;">format</span> <span style="color: #8b2252;">"%s: "</span> (<span style="color: #7a378b;">:name</span> ea))
   (wenv (<span style="color: #7a378b;">:symbol</span> symbol <span style="color: #7a378b;">:timeframe</span> timeframe)
         (<span style="color: #a020f0;">try</span>
           (<span style="color: #a020f0;">loop</span> [prev-close nil]
             (sleep 1)
             (<span style="color: #a020f0;">when-not</span> (match (? 0) <span style="color: #8b2252;">"stop"</span> true) 
               (<span style="color: #a020f0;">let</span> [new-close (close)]
                 (<span style="color: #a020f0;">when-not</span> (<span style="color: #7a378b;">=</span> new-close prev-close)
                   (<span style="color: #a020f0;">let</span> [func (get-fn start)]
                     (<span style="color: #a020f0;">if</span> (<span style="color: #7a378b;">fn?</span> func)
                       (func (<span style="color: #7a378b;">:vars</span> ea) (<span style="color: #7a378b;">:args</span> ea))
                       (warn <span style="color: #8b2252;">"%s is not a function. start cannot be called"</span> func))))
                 (<span style="color: #a020f0;">recur</span> new-close)))) 
           (<span style="color: #a020f0;">catch</span> Exception e 
             (severe <span style="color: #8b2252;">"caught exception %s ... stopping ea"</span> e)
             (.printStackTrace e))
           (<span style="color: #a020f0;">finally</span>
            (warn <span style="color: #8b2252;">"stopping ea ..."</span>)
            (catch-unexpected
             <span style="color: #8b2252;">"deinit"</span> 
             (<span style="color: #a020f0;">let</span> [de (get-fn deinit)]
               (<span style="color: #a020f0;">if</span> (<span style="color: #7a378b;">fn?</span> de)
                 (de)
                 (throwf <span style="color: #8b2252;">"deinit is not a funcion %s"</span> de)))))))))

(<span style="color: #a020f0;">defn-</span> <span style="color: #0000ff;">timeframe?</span> [a] (<span style="color: #7a378b;">number?</span> a))
(<span style="color: #a020f0;">defrecord</span> <span style="color: #0000ff;">EA</span> [name init deinit start symbol timeframe args pid run vars])

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">new-ea</span> [{<span style="color: #7a378b;">:keys</span> [name init deinit start symbol timeframe run vars]
               <span style="color: #7a378b;">:or</span> {init (<span style="color: #7a378b;">constantly</span> {})
                    deinit (<span style="color: #7a378b;">constantly</span> true)
                    timeframe (env <span style="color: #7a378b;">:timeframe</span>)
                    run run-by-tick}} args]
  (<span style="color: #228b22;">is</span> (<span style="color: #a020f0;">and</span> (<span style="color: #7a378b;">fn?</span> (get-fn init)) (<span style="color: #7a378b;">fn?</span> (get-fn deinit)) (<span style="color: #7a378b;">string?</span> name)
           (<span style="color: #7a378b;">string?</span> symbol) (<span style="color: #7a378b;">fn?</span> run) (timeframe? timeframe)))
  (EA. (<span style="color: #7a378b;">format</span> <span style="color: #8b2252;">"%s %s, %s"</span> name symbol timeframe)
       init deinit start symbol timeframe (<span style="color: #a020f0;">or</span>  args {}) nil
       run (<span style="color: #a020f0;">or</span> vars {}))) 
(<span style="color: #a020f0;">defmethod</span> <span style="color: #0000ff;">clojure.core/print-method</span> EA [o w]
  (.write w (<span style="color: #7a378b;">format</span> <span style="color: #8b2252;">"&lt;EA \"%s\" %s %s |%s|&gt;"</span>
                    (<span style="color: #7a378b;">:name</span> o)
                    (<span style="color: #a020f0;">if</span> (pid? (<span style="color: #7a378b;">:pid</span> o)) true false)                 
                    (<span style="color: #7a378b;">:args</span> o) (<span style="color: #7a378b;">:vars</span> o))))

<span style="color: #b22222;">;;</span><span style="color: #b22222;">TODO: pid without spawn!!
</span>(<span style="color: #a020f0;">defonce</span> <span style="color: #0000ff;">*ea*</span> nil)
(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">run-start</span> [ea]
  (<span style="color: #a020f0;">binding</span> [*ea* ea] 
    (<span style="color: #a020f0;">let</span> [new-ea (<span style="color: #7a378b;">merge</span> ea {<span style="color: #7a378b;">:pid</span> (spawn #((<span style="color: #7a378b;">:run</span> ea) ea))})]
      (<span style="color: #7a378b;">swap!</span> *eas* conj new-ea)
      new-ea)))

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">run-init</span> [ea]
  (debugging (<span style="color: #7a378b;">format</span> <span style="color: #8b2252;">"INIT %s: "</span> (<span style="color: #7a378b;">:name</span> ea))
             (<span style="color: #a020f0;">binding</span> [*ea* ea]
               (wenv (<span style="color: #7a378b;">:symbol</span> (<span style="color: #7a378b;">:symbol</span> ea) <span style="color: #7a378b;">:timeframe</span> (<span style="color: #7a378b;">:timeframe</span> ea))
                     (<span style="color: #a020f0;">let</span> [result ((get-fn (<span style="color: #7a378b;">:init</span> ea)) (<span style="color: #7a378b;">:args</span> ea))]
                       (<span style="color: #a020f0;">if</span> result
                         (<span style="color: #7a378b;">merge</span> ea {<span style="color: #7a378b;">:vars</span> (<span style="color: #7a378b;">merge</span> {} result)})))))))

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">run-all</span> [ea]
  (<span style="color: #a020f0;">binding</span> [*ea* ea]
    (<span style="color: #a020f0;">let</span> [new-ea (run-init ea)]
     (<span style="color: #a020f0;">if</span> (<span style="color: #7a378b;">instance?</span> EA new-ea)
       (run-start new-ea) 
       (warn <span style="color: #8b2252;">"EA %s failed to start - returned nil from INIT"</span> (<span style="color: #7a378b;">:name</span> ea))))))

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">run</span> [ea args]
  (run-all (new-ea ea args)))

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">sym</span> [] (<span style="color: #7a378b;">:symbol</span> *ea*))
(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">period</span> [] (<span style="color: #7a378b;">:period</span> *ea*))
<span style="color: #b22222;">;;</span><span style="color: #b22222;">TODO: wait till it stops and delete
</span>(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">stop</span> [ea]
  (<span style="color: #a020f0;">let</span> [stop-it (<span style="color: #7a378b;">fn</span> [e]
                  (<span style="color: #a020f0;">if</span> (pid? (<span style="color: #7a378b;">:pid</span> e))
                    (<span style="color: #a020f0;">do</span> (! (<span style="color: #7a378b;">:pid</span> e) <span style="color: #8b2252;">"stop"</span>) 
                        true)))]
    (<span style="color: #a020f0;">if</span> (<span style="color: #7a378b;">map?</span> ea)
      (stop-it ea)
      (<span style="color: #7a378b;">map</span> stop-it ea))))
</pre></div>


</div>

</div>

<div id="outline-container-4_2_3" class="outline-4">
<h4 id="sec-4_2_3"><span class="section-number-4">4.2.3</span> Error </h4>
<div class="outline-text-4" id="text-4_2_3">




<div class="org-src-container"><label class="org-src-name">error-common()</label><pre class="src src-clojure">
(<span style="color: #a020f0;">ns</span> forex.module.error.common
  (<span style="color: #7a378b;">:require</span> [forex.backend.mql.socket-service <span style="color: #7a378b;">:as</span> s])
  (<span style="color: #7a378b;">:use</span> utils.general emacs 
        forex.util.general))

<span style="color: #b22222;">;;</span><span style="color: #b22222;">raw receive
</span>(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">raw-receive</span> [msg]
  (s/receive msg))
(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">raw-receive-lst</span> [msg]
  (split (raw-receive msg) #<span style="color: #8b2252;">" +"</span>))


<span style="color: #b22222;">;;</span><span style="color: #b22222;">receive with errors
</span>(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">receive!</span> [msg]
  (<span style="color: #a020f0;">let</span> [spl (raw-receive-lst msg)]
    (<span style="color: #a020f0;">if</span> (<span style="color: #7a378b;">=</span> (<span style="color: #7a378b;">first</span> spl) <span style="color: #8b2252;">"error"</span>)
      (throwf <span style="color: #8b2252;">"MQL error %s"</span> (<span style="color: #7a378b;">second</span> spl))
      (<span style="color: #228b22;">join</span> <span style="color: #8b2252;">" "</span>  spl))))

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">receive-lst!</span> [msg]
  (<span style="color: #a020f0;">let</span> [spl (raw-receive-lst msg)]
    (<span style="color: #a020f0;">if</span> (<span style="color: #7a378b;">=</span> (<span style="color: #7a378b;">first</span> spl) <span style="color: #8b2252;">"error"</span>)
      (throwf <span style="color: #8b2252;">"MQL error %s"</span> (<span style="color: #7a378b;">second</span> spl))
      spl)))

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">receive-double!</span> [msg]
  (Double/parseDouble (receive! msg)))

<span style="color: #b22222;">;;</span><span style="color: #b22222;">receive with default instead of errors, returns error object for errors
</span><span style="color: #b22222;">;;</span><span style="color: #b22222;">is customizable to default to errors!
</span>(<span style="color: #a020f0;">defrecord</span> <span style="color: #0000ff;">MqlError</span> [e])
(<span style="color: #a020f0;">defonce-</span> <span style="color: #0000ff;">*er*</span> (<span style="color: #7a378b;">gensym</span>)) 
(<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">*default*</span> *er*)

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">e?</span> [a] (<span style="color: #7a378b;">instance?</span> MqlError a))

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">aif</span>
  ([test then] `(aif ~test ~then nil))
  ([test then else]
     `(<span style="color: #a020f0;">let</span> [~'it ~test]
        (<span style="color: #a020f0;">if</span> (<span style="color: #a020f0;">and</span> test (<span style="color: #7a378b;">not</span> (e? ~'it)))
          ~then
          ~else))))
(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">awhen</span> [test &amp; body] `(aif ~test (<span style="color: #a020f0;">do</span> ~@body)))
(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">aif-not</span>
  ([test then] `(aif-not ~test ~then nil))
  ([test then else]
     `(<span style="color: #a020f0;">let</span> [~'it ~test]
        (<span style="color: #a020f0;">if</span> (<span style="color: #7a378b;">not</span> (<span style="color: #a020f0;">and</span> test (<span style="color: #7a378b;">not</span> (e? ~'it))))
          ~then
          ~else))))
(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">awhen-not</span> [test &amp; body] `(aif-not ~test (<span style="color: #a020f0;">do</span> ~@body)))

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">receive</span>
  ([msg] (receive msg *default*))
  ([msg default]
     (<span style="color: #a020f0;">let</span> [spl (raw-receive-lst msg)]
       (<span style="color: #a020f0;">if</span> (<span style="color: #7a378b;">=</span> (<span style="color: #7a378b;">first</span> spl) <span style="color: #8b2252;">"error"</span>)
         (<span style="color: #a020f0;">if</span> (<span style="color: #7a378b;">=</span> default *er*)
           (MqlError. (Integer/parseInt (<span style="color: #7a378b;">second</span> spl)))
           (<span style="color: #a020f0;">if</span> (<span style="color: #7a378b;">fn?</span> default) (default (MqlError. (Integer/parseInt (<span style="color: #7a378b;">second</span> spl)))) default))
         (<span style="color: #228b22;">join</span> <span style="color: #8b2252;">""</span> spl)))))

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">receive-double</span>
  ([msg] (receive-double msg *default*))
  ([msg default]
     (<span style="color: #a020f0;">let</span> [spl (raw-receive-lst msg)]
       (<span style="color: #a020f0;">if</span> (<span style="color: #7a378b;">=</span> (<span style="color: #7a378b;">first</span> spl) <span style="color: #8b2252;">"error"</span>)
         (<span style="color: #a020f0;">if</span> (<span style="color: #7a378b;">=</span> default *er*)
           (MqlError. (Integer/parseInt (<span style="color: #7a378b;">second</span> spl)))
           (<span style="color: #a020f0;">if</span> (<span style="color: #7a378b;">fn?</span> default) (default (MqlError. (Integer/parseInt (<span style="color: #7a378b;">second</span> spl)))) default))
         (Double/parseDouble (<span style="color: #228b22;">join</span> <span style="color: #8b2252;">" "</span>  spl))))))

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">receive-int</span> [s]
  (aif (receive-double s)
       (<span style="color: #7a378b;">int</span> it)
       it))
</pre></div>


</div>

</div>

<div id="outline-container-4_2_4" class="outline-4">
<h4 id="sec-4_2_4"><span class="section-number-4">4.2.4</span> Indicator </h4>
<div class="outline-text-4" id="text-4_2_4">




<div class="org-src-container"><label class="org-src-name">indicator-common()</label><pre class="src src-clojure">
(<span style="color: #a020f0;">ns</span> forex.module.indicator.common
  (<span style="color: #7a378b;">:use</span>
   utils.general 
   forex.util.general
   forex.module.account.common
   forex.module.error.common)
  (<span style="color: #7a378b;">:require</span> [forex.module.error.common <span style="color: #7a378b;">:as</span> s]))

<span style="color: #b22222;">;;</span><span style="color: #b22222;">high low open close
</span>(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">get-rel-data</span> [<span style="color: #228b22;">^String</span> symbol <span style="color: #228b22;">^Integer</span> timeframe <span style="color: #228b22;">^Integer</span> from <span style="color: #228b22;">^Integer</span> to]
  (<span style="color: #228b22;">is</span>  (<span style="color: #7a378b;">&gt;=</span> to from) <span style="color: #8b2252;">"in get-data, from/to is invalid"</span>)
  (<span style="color: #a020f0;">loop</span> [dat nil retries 0]
    (<span style="color: #a020f0;">if</span> (<span style="color: #7a378b;">&gt;</span> retries 3) (throwf <span style="color: #8b2252;">"MQL error %s"</span> (<span style="color: #7a378b;">second</span> dat)))
    (<span style="color: #a020f0;">let</span> [data (s/raw-receive-lst (<span style="color: #7a378b;">format</span> <span style="color: #8b2252;">"bars_relative %s %s %s %s"</span>
                                      symbol timeframe from to))]
      (<span style="color: #a020f0;">if</span> (<span style="color: #7a378b;">=</span> (<span style="color: #7a378b;">first</span> data) <span style="color: #8b2252;">"error"</span>) 
        (<span style="color: #a020f0;">do</span> (sleep 0.4) (<span style="color: #a020f0;">recur</span> data (<span style="color: #7a378b;">+</span> retries 1)))
        data)))) 

(<span style="color: #a020f0;">defn-</span> <span style="color: #0000ff;">rel</span> [i]
  (<span style="color: #a020f0;">let</span> [sym (env <span style="color: #7a378b;">:symbol</span>)
        time (env <span style="color: #7a378b;">:timeframe</span>)]
    (<span style="color: #228b22;">is</span> (<span style="color: #a020f0;">and</span> (<span style="color: #7a378b;">string?</span> sym) (<span style="color: #7a378b;">integer?</span> time)))
    (get-rel-data sym time i i)))

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">high</span>
  ([] (high 0)) 
  ([i] (Double/parseDouble (<span style="color: #7a378b;">nth</span> (rel i) 1))))
(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">open</span> 
  ([] (open 0))
  ([i] (Double/parseDouble (<span style="color: #7a378b;">nth</span> (rel i) 3))))
(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">low</span>
  ([] (low 0))
  ([i] (Double/parseDouble (<span style="color: #7a378b;">nth</span> (rel i) 2))))
(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">close</span>
  ([] (close 0))
  ([i] (Double/parseDouble (<span style="color: #7a378b;">nth</span> (rel i) 4))))

<span style="color: #b22222;">;;</span><span style="color: #b22222;">TODO: change
</span>(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">ask</span>
  ([] (ask 0))
  ([i] (iff (mode-ask (env <span style="color: #7a378b;">:symbol</span>)) it (throwf <span style="color: #8b2252;">"MQL error %s"</span> (<span style="color: #7a378b;">:e</span> it)))))
<span style="color: #b22222;">;;</span><span style="color: #b22222;">bid==close 
</span>(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">bid</span>
  ([] (bid 0))
  ([i] (iff (mode-bid (env <span style="color: #7a378b;">:symbol</span>)) it (throwf <span style="color: #8b2252;">"MQL error %s"</span> (<span style="color: #7a378b;">:e</span> it)))))
</pre></div>



</div>
</div>

</div>

<div id="outline-container-4_3" class="outline-3">
<h3 id="sec-4_3"><span class="section-number-3">4.3</span> Util </h3>
<div class="outline-text-3" id="text-4_3">


</div>

<div id="outline-container-4_3_1" class="outline-4">
<h4 id="sec-4_3_1"><span class="section-number-4">4.3.1</span> General </h4>
<div class="outline-text-4" id="text-4_3_1">




<div class="org-src-container"><label class="org-src-name">forex-util-general()</label><pre class="src src-clojure">
(<span style="color: #a020f0;">ns</span> forex.util.general
  (<span style="color: #7a378b;">:use</span> utils.general forex.util.spawn forex.util.log)
  (<span style="color: #7a378b;">:import</span> (org.joda.time DateTime DateTimeZone Instant)))


(<span style="color: #a020f0;">deftype</span> <span style="color: #0000ff;">AtomHash</span> [val]
  Object
  (toString [this] (<span style="color: #7a378b;">str</span> <span style="color: #8b2252;">"&lt;AtomHash "</span> @val <span style="color: #8b2252;">"&gt;"</span>))
  clojure.lang.IPersistentMap
  <span style="color: #b22222;">;;</span><span style="color: #b22222;">ILookup
</span>  (valAt [this key] (<span style="color: #7a378b;">get</span> @val key))
  (valAt [this key notfound] (<span style="color: #7a378b;">get</span> @val key notfound))
  <span style="color: #b22222;">;;</span><span style="color: #b22222;">IPersistentCollection
</span>  (<span style="color: #7a378b;">count</span> [this] (.count @val))
  (<span style="color: #7a378b;">empty</span> [this]  {})
  (<span style="color: #7a378b;">cons</span> [this e]  (.cons @val e))
  (equiv [this gs] (<span style="color: #a020f0;">or</span> (<span style="color: #7a378b;">identical?</span> this gs)
                       (<span style="color: #a020f0;">when</span> (<span style="color: #7a378b;">identical?</span> (<span style="color: #7a378b;">class</span> this) (<span style="color: #7a378b;">class</span> gs))
                         (.equiv @val) gs)))
  (containsKey [this k] (<span style="color: #a020f0;">or</span> (<span style="color: #a020f0;">and</span> (<span style="color: #7a378b;">get</span> @val k) true) false))
  (entryAt [this k] (<span style="color: #7a378b;">get</span> @val k))
  <span style="color: #b22222;">;;</span><span style="color: #b22222;">Seqable
</span>  (<span style="color: #7a378b;">seq</span> [this] (<span style="color: #7a378b;">seq</span> @val))
  <span style="color: #b22222;">;;</span><span style="color: #b22222;">Associative
</span>  (<span style="color: #7a378b;">assoc</span> [this k g] (<span style="color: #7a378b;">assoc</span> @val k g))
  (assocEx [this k g] (<span style="color: #7a378b;">assoc</span> this k g))
  (without [this k] (.without @val k))
  clojure.lang.IDeref
  (<span style="color: #7a378b;">deref</span> [this] @val))

(<span style="color: #a020f0;">defmethod</span> <span style="color: #0000ff;">clojure.core/print-method</span> AtomHash [o w]
  (.write w (.toString o)))

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">atom-hash</span> [val]
  (<span style="color: #228b22;">is</span> (<span style="color: #7a378b;">map?</span> val))
  (AtomHash. (<span style="color: #7a378b;">atom</span> val)))


(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">symbolicate</span>
  <span style="color: #8b2252;">"symbolicate symbols together. ignores things like whitespaces, just drops them!"</span>
  [&amp; args]
  (<span style="color: #7a378b;">symbol</span> (<span style="color: #7a378b;">apply</span> str args)))


<span style="color: #b22222;">;;</span><span style="color: #b22222;">TODO: add support for waiting on multiple objects, including sockets!
</span>(<span style="color: #a020f0;">defprotocol</span> <span style="color: #0000ff;">PWait</span>
  (wait-for [this timeout units] [this timeout]))
<span style="color: #b22222;">;;</span><span style="color: #b22222;">copied from clojure source, but adding timeout wait-for
</span>(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">beg</span>
  <span style="color: #8b2252;">"Alpha - subject to change.
  Returns a promise object that can be read with deref/@, and set,
  once only, with deliver. Calls to deref/@ prior to delivery will
  block. All subsequent derefs will return the same delivered value
  without blocking."</span>
  {<span style="color: #7a378b;">:added</span> <span style="color: #8b2252;">"1.1"</span>}
  []
  (<span style="color: #a020f0;">let</span> [d (java.util.concurrent.CountDownLatch. 1)
        v (<span style="color: #7a378b;">atom</span> nil)]
    (<span style="color: #7a378b;">reify</span> 
      clojure.lang.IDeref
      (<span style="color: #7a378b;">deref</span> [_] (.await d) @v)
      PWait
      (wait-for [this timeout]
                (wait-for this timeout
                          java.util.concurrent.TimeUnit/MILLISECONDS))
      (wait-for [this timeout units]
                (<span style="color: #a020f0;">if</span> timeout
                  (.await d timeout units)
                  (<span style="color: #a020f0;">do</span> (.await d) true)))
      clojure.lang.IFn
      (invoke [this x] 
              (<span style="color: #7a378b;">locking</span> d
                (<span style="color: #a020f0;">if</span> (<span style="color: #7a378b;">pos?</span> (.getCount d))
                  (<span style="color: #a020f0;">do</span> (<span style="color: #7a378b;">reset!</span> v x)
                      (.countDown d)
                      x)
                  (<span style="color: #a020f0;">throw</span>
                   (IllegalStateException.
                    <span style="color: #8b2252;">"Multiple deliver calls to a promise"</span>))))))))

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">give</span>
  <span style="color: #8b2252;">"Alpha - subject to change.
  Delivers the supplied value to the promise, releasing any pending
  derefs. A subsequent call to deliver on a promise will throw an exception."</span>
  {<span style="color: #7a378b;">:added</span> <span style="color: #8b2252;">"1.1"</span>}
  [promise val]
  (<span style="color: #7a378b;">promise</span> val))

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">naive-var-local-cache-strategy</span> [var] 
 `(<span style="color: #a020f0;">let</span> [cache# (<span style="color: #7a378b;">atom</span> {})]
    (<span style="color: #7a378b;">reify</span> PCachingStrategy
      (retrieve [_ item#] (<span style="color: #7a378b;">get</span> @cache# item#))
      (cached? [_ item#] (<span style="color: #7a378b;">contains?</span> @cache# item#))
      (hit [this# _] this#)
      (miss [this# item# result#]
            (<span style="color: #7a378b;">reset!</span> cache# (<span style="color: #7a378b;">swap!</span> ~var assoc item# result#))
            this#))))

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">constants</span> [&amp; args]
  `(<span style="color: #a020f0;">do</span> ~@(<span style="color: #7a378b;">map</span> (<span style="color: #7a378b;">fn</span> [[name val]] `(<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">~name</span> ~val)) (group args 2))))

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">spawn-log</span> [func]
  `(spawn (<span style="color: #7a378b;">fn</span> [] (<span style="color: #a020f0;">try</span> (~func) (<span style="color: #a020f0;">catch</span> Exception e#
                                (.printStackTrace e#) (severe e#))))))

(<span style="color: #a020f0;">defonce</span> <span style="color: #0000ff;">*env*</span> (<span style="color: #7a378b;">atom</span> {<span style="color: #7a378b;">:timeframe</span> 1440 <span style="color: #7a378b;">:symbol</span> <span style="color: #8b2252;">"EURUSD"</span>})) <span style="color: #b22222;">;</span><span style="color: #b22222;">default +D1+, EURUSD
</span>(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">env</span> [key] (<span style="color: #7a378b;">key</span> @*env*))
(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">env!</span> [map]
  (<span style="color: #7a378b;">swap!</span> *env* #(<span style="color: #7a378b;">merge</span> % map))
  map)

<span style="color: #b22222;">;;</span><span style="color: #b22222;">todo: fix private!
</span><span style="color: #b22222;">;;</span><span style="color: #b22222;">todo: ignores all nils?
</span>(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">wenv</span> [[&amp; args] &amp; body] 
  `(<span style="color: #a020f0;">binding</span> [forex.util.general/*env*
             (<span style="color: #7a378b;">atom</span> (<span style="color: #7a378b;">merge</span> @@~#'*env* (<span style="color: #7a378b;">hash-map</span> ~@args)))]
     ~@body))
</pre></div>


</div>

</div>

<div id="outline-container-4_3_2" class="outline-4">
<h4 id="sec-4_3_2"><span class="section-number-4">4.3.2</span> Log </h4>
<div class="outline-text-4" id="text-4_3_2">




<div class="org-src-container"><label class="org-src-name">forex-util-log()</label><pre class="src src-clojure">
(<span style="color: #a020f0;">ns</span> forex.util.log
  (<span style="color: #7a378b;">:import</span> [java.util.logging Logger Level LogManager Handler
            FileHandler SimpleFormatter ConsoleHandler])
  (<span style="color: #7a378b;">:require</span> [clojure.contrib.duck-streams <span style="color: #7a378b;">:as</span> f])
  (<span style="color: #7a378b;">:use</span> emacs utils.general))

<span style="color: #b22222;">;;</span><span style="color: #b22222;">TODO: minor mode
</span>(<span style="color: #a020f0;">defvar</span> <span style="color: #0000ff;">log-dir</span> <span style="color: #8b2252;">"%h/.forex"</span>
  <span style="color: #8b2252;">"Directory of logging"</span>)

(<span style="color: #a020f0;">defn-</span> <span style="color: #0000ff;">formatter</span> []
  (<span style="color: #a020f0;">let</span> [d (java.util.Date.)]
    (<span style="color: #7a378b;">proxy</span> [java.util.logging.Formatter] []
      (<span style="color: #7a378b;">format</span> [r] 
              (clojure.core/<span style="color: #7a378b;">format</span> <span style="color: #8b2252;">"%s%n%s: %s%n%n"</span>
                                   (<span style="color: #a020f0;">do</span> (.setTime d (.getMillis r)) d)
                                   (.getLevel r)
                                   (.getMessage r))))))

<span style="color: #b22222;">;;</span><span style="color: #b22222;">wrap the PrintWriter *out* in an OutputStream to be used in ConsoleHandler
</span>(<span style="color: #a020f0;">defn-</span> <span style="color: #0000ff;">new-out-stream</span> [out]
  (<span style="color: #7a378b;">proxy</span> [java.io.OutputStream] []
    (close [] (.close out))
    (<span style="color: #7a378b;">flush</span> [] (.flush out))
    (write ([b] (.print out (String. b)))
           ([b off len] (.print out (String. b off len))))))

<span style="color: #b22222;">;;</span><span style="color: #b22222;">TODO: if user deletes log file, it will not be recreated
</span><span style="color: #b22222;">;;</span><span style="color: #b22222;">this will create a logger which logs to /home/dir/.forex/log.log and will output to System/out (in emacs+slime, this is in the *inferior-lisp* buffer
</span><span style="color: #b22222;">;;</span><span style="color: #b22222;">or in the *shell* if you do lein swank
</span>
(<span style="color: #a020f0;">defn-</span> <span style="color: #0000ff;">new-logger</span> [file]
  (f/make-parents
   (java.io.File. (<span style="color: #7a378b;">format</span> <span style="color: #8b2252;">"%s/.forex/%s"</span> (System/getProperty <span style="color: #8b2252;">"user.home"</span>) file)))
  (<span style="color: #a020f0;">let</span> [l (java.util.logging.Logger/getLogger (<span style="color: #7a378b;">str</span> *ns*))]
    (mapc #(.removeHandler l %) (.getHandlers l))
    (.addHandler l (<span style="color: #a020f0;">doto</span> (ConsoleHandler.) (.setFormatter (formatter))) <span style="color: #b22222;">;;</span><span style="color: #b22222;">(new-out-stream *out*) = to *out*, but sort of clutters everything
</span>                 )
    (.addHandler l (<span style="color: #a020f0;">doto</span> (FileHandler. (<span style="color: #7a378b;">str</span> log-dir <span style="color: #8b2252;">"/"</span> file))
                     (.setFormatter (formatter))))
    (.setUseParentHandlers l false)
    l))

(<span style="color: #a020f0;">defonce-</span> <span style="color: #0000ff;">log</span> (java.util.logging.Logger/getLogger (<span style="color: #7a378b;">str</span> *ns*)))

<span style="color: #b22222;">;;</span><span style="color: #b22222;">TODO: only use one log file!!! eh?
</span>(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">init-logger</span> []
  (<span style="color: #a020f0;">if-not</span> log
   (<span style="color: #a020f0;">def-</span> <span style="color: #0000ff;">log</span> (new-logger <span style="color: #8b2252;">"log"</span>))))
(init-logger)
<span style="color: #b22222;">;;</span><span style="color: #b22222;">TODO: set filtering levels
</span><span style="color: #b22222;">;;</span><span style="color: #b22222;">fine,finer,finest wont log
</span>
(<span style="color: #a020f0;">def-</span> <span style="color: #0000ff;">*debug-info*</span> <span style="color: #8b2252;">""</span>)
(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">debugging</span> [str &amp; args] `(<span style="color: #a020f0;">binding</span> [*debug-info* ~str] ~@args))

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">info</span> [msg &amp; args]
  (.info log (<span style="color: #7a378b;">apply</span> format (<span style="color: #7a378b;">str</span> *debug-info* <span style="color: #8b2252;">" "</span> msg) args)))
(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">out</span> [msg &amp; args]
  (<span style="color: #7a378b;">println</span> (<span style="color: #7a378b;">apply</span> format (<span style="color: #7a378b;">str</span> <span style="color: #8b2252;">"INFO: "</span> *debug-info* <span style="color: #8b2252;">" "</span> msg) args))
  (<span style="color: #7a378b;">apply</span> info msg args)
  nil)

 (<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">fine</span> [msg &amp; args]
   (.fine log (<span style="color: #7a378b;">apply</span> format  (<span style="color: #7a378b;">str</span> *debug-info* <span style="color: #8b2252;">" "</span> msg) args)))
 (<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">finer</span> [msg &amp; args]
   (.finer log (<span style="color: #7a378b;">apply</span> format (<span style="color: #7a378b;">str</span> *debug-info* <span style="color: #8b2252;">" "</span> msg) args)))
 (<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">finest</span> [msg &amp; args]
   (.finest log (<span style="color: #7a378b;">apply</span> format (<span style="color: #7a378b;">str</span> *debug-info* <span style="color: #8b2252;">" "</span> msg) args)))
(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">severe</span> [msg &amp; args]
  (<span style="color: #a020f0;">let</span> [s (<span style="color: #7a378b;">apply</span> format (<span style="color: #7a378b;">str</span> *debug-info* <span style="color: #8b2252;">" "</span> msg) args)]
    (.severe log s)
    (<span style="color: #7a378b;">print</span> (<span style="color: #7a378b;">format</span> <span style="color: #8b2252;">"SEVERE: %s%n"</span> s))))
(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">warn</span> [msg &amp; args]
  (<span style="color: #a020f0;">let</span> [s (<span style="color: #7a378b;">apply</span> format (<span style="color: #7a378b;">str</span> *debug-info* <span style="color: #8b2252;">" "</span> msg) args)]
    (.warning log s) 
    (<span style="color: #7a378b;">print</span> (<span style="color: #7a378b;">format</span> <span style="color: #8b2252;">"WARNING: %s%n"</span> s))))
</pre></div>


</div>

</div>

<div id="outline-container-4_3_3" class="outline-4">
<h4 id="sec-4_3_3"><span class="section-number-4">4.3.3</span> Spawn </h4>
<div class="outline-text-4" id="text-4_3_3">




<div class="org-src-container"><label class="org-src-name">forex-util-spawn()</label><pre class="src src-clojure">
(<span style="color: #a020f0;">ns</span> forex.util.spawn
  (<span style="color: #7a378b;">:use</span> utils.general forex.util.zmq)
  (<span style="color: #7a378b;">:require</span> [utils.fiber.spawn <span style="color: #7a378b;">:as</span> s]))

(<span style="color: #a020f0;">def-</span> <span style="color: #0000ff;">*pid*</span> (<span style="color: #7a378b;">atom</span> []))

(<span style="color: #a020f0;">defalias</span> <span style="color: #0000ff;">pid?</span> s/pid?)
(<span style="color: #a020f0;">defalias</span> <span style="color: #0000ff;">self</span> s/self)
(<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">kill-all</span> s/kill-all)
(<span style="color: #a020f0;">defalias</span> <span style="color: #0000ff;">spawn-in-repl</span> s/spawn-in-repl) <span style="color: #b22222;">;;</span><span style="color: #b22222;">TODO: add socket for this one
</span>
(<span style="color: #a020f0;">defalias</span> <span style="color: #0000ff;">?</span> s/?)

(<span style="color: #a020f0;">defalias</span> <span style="color: #0000ff;">make-tag</span> s/make-tag)
(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">!</span> [pid msg]
  (<span style="color: #a020f0;">with-open</span> [local (<span style="color: #a020f0;">doto</span> (new-socket +push+)
                      (.connect (<span style="color: #7a378b;">format</span> <span style="color: #8b2252;">"inproc://%s"</span> pid)))]
    (s/! pid msg)
    (.snd local <span style="color: #8b2252;">"REQUEST"</span> +noblock+)))
(<span style="color: #a020f0;">defn</span>  <span style="color: #0000ff;">stop-all</span> []
  (<span style="color: #7a378b;">swap!</span> *pid*
         (<span style="color: #7a378b;">fn</span> [old]
           (<span style="color: #7a378b;">map</span> #(<span style="color: #a020f0;">if</span> (pid? %)
                   (! % <span style="color: #8b2252;">"STOP"</span>)) @*pid*))))


(<span style="color: #a020f0;">defrecord</span> <span style="color: #0000ff;">LocalSocket</span> [socket]
  PSocket
  (raw [this] (.raw socket)) 
  (recv [this flags] 
        (<span style="color: #a020f0;">let</span> [r (.recv socket flags)]
          (s/?)))
  (recv [this] (recv this 0))
  (close [this] (.close socket))
  (hasReceiveMore [this] false))


(<span style="color: #7a378b;">comment</span>
  (<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">te</span> []
   (<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">pid</span> (spawn #(<span style="color: #a020f0;">do</span> (<span style="color: #7a378b;">pr</span> <span style="color: #8b2252;">"BEFORE"</span>) (<span style="color: #7a378b;">pr</span> local)
                        (pformat <span style="color: #8b2252;">"local %s%n"</span> (<span style="color: #7a378b;">first</span> (event-seq [local])))
                        (<span style="color: #7a378b;">pr</span> <span style="color: #8b2252;">"AFTER"</span>))))))


(<span style="color: #a020f0;">defonce-</span> <span style="color: #0000ff;">*local*</span> (ThreadLocal.))
(<span style="color: #a020f0;">defn-</span> <span style="color: #0000ff;">self-get</span> [key]
  (<span style="color: #a020f0;">let</span> [map (.get *local*)]
    (<span style="color: #a020f0;">when</span> map 
      (<span style="color: #7a378b;">map</span> key))))
(<span style="color: #a020f0;">defn-</span> <span style="color: #0000ff;">self-assoc</span> [key obj]
  (<span style="color: #a020f0;">let</span> [map (.get *local*)]
    (<span style="color: #a020f0;">if</span> map 
     (.set *local* (<span style="color: #7a378b;">assoc</span> map key obj)))))
(<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">local</span> nil)
(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">spawn</span> [thunk]
  (<span style="color: #a020f0;">let</span> [pid (s/spawn (<span style="color: #7a378b;">fn</span> [] 
                       (.set *local* {})
                       (<span style="color: #a020f0;">with-open</span>
                           [local-socket (LocalSocket. 
                                   (<span style="color: #a020f0;">doto</span>
                                       (new-socket +pull+)
                                     (.bind  (<span style="color: #7a378b;">str</span> <span style="color: #8b2252;">"inproc://"</span> (self)))))]        
                         (<span style="color: #a020f0;">binding</span> [local local-socket]
                           (thunk)))))]
    (<span style="color: #7a378b;">swap!</span> *pid* concat [pid])
    pid))

(<span style="color: #a020f0;">defmulti</span> <span style="color: #0000ff;">event-seq</span> class)
(<span style="color: #a020f0;">defmethod</span> <span style="color: #0000ff;">event-seq</span> clojure.lang.IPersistentVector [v]
  (event-seq (new-poller v)))
(<span style="color: #a020f0;">defmethod</span> <span style="color: #0000ff;">event-seq</span> forex.util.zmq.Poller [p]
  ((<span style="color: #7a378b;">fn</span> <span style="color: #0000ff;">the-seq</span> [p] 
     (<span style="color: #7a378b;">lazy-seq</span>
      (<span style="color: #a020f0;">let</span> [amount (.poll p)] 
        (<span style="color: #7a378b;">concat</span> (<span style="color: #a020f0;">for</span> [i (<span style="color: #7a378b;">range</span> 0 (.getSize p)) <span style="color: #7a378b;">:when</span> (.pollin p i)]
                  (<span style="color: #a020f0;">let</span> [sock (.getSocket p i)
                        msg 
                        (<span style="color: #a020f0;">loop</span> [msg [(.recv sock 0)]]                    
                          (<span style="color: #a020f0;">if</span> (.hasReceiveMore sock)
                            (<span style="color: #a020f0;">recur</span> (<span style="color: #7a378b;">cons</span> (String. (.recv sock 0)) msg))
                            msg))]
                    [sock (<span style="color: #a020f0;">if</span> (<span style="color: #7a378b;">=</span> (<span style="color: #7a378b;">count</span> msg) 1) (<span style="color: #7a378b;">first</span> msg) (<span style="color: #7a378b;">vec</span> msg))]))
                (the-seq p)))))
   p)) 

<span style="color: #b22222;">;;</span><span style="color: #b22222;">? with multiple sources or change to poll
</span><span style="color: #b22222;">;;</span><span style="color: #b22222;">!? (timeout)
</span><span style="color: #b22222;">;;</span><span style="color: #b22222;">?? (filter)
</span></pre></div>


</div>

</div>

<div id="outline-container-4_3_4" class="outline-4">
<h4 id="sec-4_3_4"><span class="section-number-4">4.3.4</span> ZMQ </h4>
<div class="outline-text-4" id="text-4_3_4">




<div class="org-src-container"><label class="org-src-name">forex-util-zmq()</label><pre class="src src-clojure">
(<span style="color: #a020f0;">ns</span> forex.util.zmq
  (<span style="color: #7a378b;">:import</span> (org.zeromq ZMQ))
  (<span style="color: #7a378b;">:use</span> utils.general))
(<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">+noblock+</span> 1)

(<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">+p2p+</span> 0)
(<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">+pub+</span> 1)
(<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">+sub+</span> 2)
(<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">+req+</span> 3)
(<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">+rep+</span> 4)
(<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">+xreq+</span> 5)
(<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">+xrep+</span> 6)
(<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">+pull+</span> 7)
(<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">+push+</span> 8)

(<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">+hwm+</span> 1)
(<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">+lwm+</span> 2)
(<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">+swap+</span> 3)
(<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">+affinity+</span> 4)
(<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">+identity+</span> 5)
(<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">+subscribe+</span> 6)
(<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">+unsubscribe+</span> 7)
(<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">+rate+</span> 8)
(<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">+recovery-ivl+</span> 9)
(<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">+mcast-loop+</span> 10)
(<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">+sndbuf+</span> 11)
(<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">+rcvbuf+</span> 12)

(<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">+pollin+</span> 1)
(<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">+pollout+</span> 2)
(<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">+pollerr+</span> 4)
(<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">+more+</span> 2)

<span style="color: #b22222;">;;</span><span style="color: #b22222;">Context
</span>(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">new-context</span> [io-threads]
  (ZMQ/context io-threads))
(<span style="color: #a020f0;">defonce</span> <span style="color: #0000ff;">*context*</span> (new-context 1))

(<span style="color: #a020f0;">defprotocol</span> <span style="color: #0000ff;">PSocket</span>
  (raw [this])
  (recv [this flags] [this])
  (bind [this address])
  (connect [this address])
  (hasReceiveMore [this])
  (close [this])
  (snd [this msg flags]))
(<span style="color: #a020f0;">defprotocol</span> <span style="color: #0000ff;">PPoller</span>
  (setTimeout [this timeout])
  (poll [this])
  (register [this socket])
  (getSocket [this i])
  (getSize [this])
  (pollin [this i])) 
(<span style="color: #a020f0;">defrecord</span> <span style="color: #0000ff;">Poller</span> [poll sockets]
  PPoller 
  (getSize [this] (.getSize (<span style="color: #7a378b;">:poll</span> this)))
  (pollin [this i] (.pollin (<span style="color: #7a378b;">:poll</span> this) i))
  (setTimeout [this timeout] (.setTimeout (<span style="color: #7a378b;">:poll</span> this) timeout))
  (poll [this] (.poll (<span style="color: #7a378b;">:poll</span> this)))
  (register [this socket]
            (.register (<span style="color: #7a378b;">:poll</span> this)
                       (<span style="color: #a020f0;">if</span> (<span style="color: #7a378b;">extends?</span> PSocket (<span style="color: #7a378b;">class</span> socket))
                         (.raw socket)
                         socket))
            (<span style="color: #7a378b;">swap!</span> (<span style="color: #7a378b;">:sockets</span> this) conj socket))
  (getSocket [this i] (<span style="color: #7a378b;">nth</span> @(<span style="color: #7a378b;">:sockets</span> this) i)))

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">new-poller</span>
  ([sockets] (new-poller *context* sockets))
  ([context sockets]
     (<span style="color: #a020f0;">let</span> [p (Poller. (.poller context (<span style="color: #7a378b;">count</span> sockets)) (<span style="color: #7a378b;">atom</span> []))]
       (.setTimeout p -1)
       (on [sock sockets]
           (.register p sock))
       p)))

(<span style="color: #a020f0;">defrecord</span> <span style="color: #0000ff;">Socket</span> [socket]
  PSocket
  (raw [this] (<span style="color: #7a378b;">:socket</span> this))
  (snd [this msg flags] (.send socket (.getBytes msg) flags))
  (recv [this flags] (String. (.recv socket flags)))
  (recv [this] (recv this 0)) 
  (close [this] (.close socket))
  (bind [this address] (.bind socket address))
  (connect [this address] (.connect socket address))
  (hasReceiveMore [this] (.hasReceiveMore socket)))

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">new-socket</span>
  ([type] (new-socket *context* type))
  ([context type] (Socket. (.socket context type))))

(<span style="color: #7a378b;">comment</span>
  (<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">new-poll</span>
    ([sockets] (new-poll *context* sockets))
    ([context sockets]
       (<span style="color: #a020f0;">let</span> [p (.poller context (<span style="color: #7a378b;">count</span> sockets))]
         (.setTimeout p -1)
         (on [sock sockets]
             (.register p (.socket sock)))
         p)))

  (<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">new-socket</span>
    ([socket-type]
       (new-socket *context* socket-type))
    ([context socket-type ]
       (.socket context socket-type))))
</pre></div>


</div>

</div>

<div id="outline-container-4_3_5" class="outline-4">
<h4 id="sec-4_3_5"><span class="section-number-4">4.3.5</span> Devel </h4>
<div class="outline-text-4" id="text-4_3_5">




<div class="org-src-container"><label class="org-src-name">forex-util-mql-devel()</label><pre class="src src-clojure">
(<span style="color: #a020f0;">ns</span> forex.utils.mql-devel
  (<span style="color: #7a378b;">:use</span> utils.general))

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">cond-out</span> [&amp; args]
  (<span style="color: #7a378b;">apply</span> str (<span style="color: #7a378b;">map</span> (<span style="color: #7a378b;">fn</span> [a]
                    (<span style="color: #a020f0;">let</span> [name (<span style="color: #7a378b;">str</span> a)]
                      (<span style="color: #7a378b;">format</span> <span style="color: #8b2252;">" else if (command==\"%s\") {\n\t   ret = process_%s(request);\n\t}"</span> name name)))
                  args)))

(cond-out
 AccountBalance
 AccountCredit
 AccountCompany
 AccountCurrency
 AccountEquity
 AccountFreeMargin
 AccountLeverage
 AccountMargin
 AccountName
 AccountNumber
 AccountServer
 AccountProfit
 OrderLots
 OrderDelete
 OrderCloseTime
 OrderType
 OrdersTotal
 OrderSend
 MarketInfo
 OrderClose
 OrderModify)
</pre></div>


</div>
</div>

</div>

<div id="outline-container-4_4" class="outline-3">
<h3 id="sec-4_4"><span class="section-number-3">4.4</span> User </h3>
<div class="outline-text-3" id="text-4_4">




<div class="org-src-container"><label class="org-src-name">forex_user()</label><pre class="src src-clojure">
(<span style="color: #a020f0;">ns</span> forex-user
  (<span style="color: #7a378b;">:use</span> forex.util.general utils.general
        forex.util.log) 
  (<span style="color: #7a378b;">:use</span> forex.module.error.common
        forex.module.ea.common
        forex.module.indicator.common
        forex.module.account.common
        [clj-time.core <span style="color: #7a378b;">:exclude</span> [extend start]])
  (<span style="color: #7a378b;">:require</span>
   [forex.backend.mql.socket-service <span style="color: #7a378b;">:as</span> backend])) 

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">pip-price</span>
  ([] (pip-price (env <span style="color: #7a378b;">:symbol</span>)))
  ([symbol] (mode-tickvalue symbol)))
<span style="color: #b22222;">;;</span><span style="color: #b22222;">TODO: mql err on point? no way! we should throw an error
</span>(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">clear-eas</span> [] (<span style="color: #7a378b;">count</span> (<span style="color: #7a378b;">reset!</span> *eas* (<span style="color: #7a378b;">filter</span> alive? @*eas*))))

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">point</span> 
  ([] (point (env <span style="color: #7a378b;">:symbol</span>)))
  ([symbol]
     (<span style="color: #7a378b;">*</span> 10 (mode-point symbol))))
(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">pips</span>   
  ([price] (pips price (env <span style="color: #7a378b;">:symbol</span>)))
  ([price symbol] 
     (<span style="color: #7a378b;">/</span> price (point symbol)))) 
(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">price-of</span> 
  ([val] (price-of val (env <span style="color: #7a378b;">:symbol</span>)))
  ([val symbol]
     (<span style="color: #7a378b;">*</span> (pip-price symbol) (pips val)))) 
(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">exit</span> [&amp; args] 
  (throwf (<span style="color: #7a378b;">apply</span> format args)))
(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">sell?</span> [{type <span style="color: #7a378b;">:type</span>}]
  (<span style="color: #a020f0;">or</span> (<span style="color: #7a378b;">=</span> type <span style="color: #7a378b;">:sell</span>) (<span style="color: #7a378b;">=</span> type <span style="color: #7a378b;">:sell-stop</span>) (<span style="color: #7a378b;">=</span> type <span style="color: #7a378b;">:sell-limit</span>)))
(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">buy?</span> [{type <span style="color: #7a378b;">:type</span>}]
  (<span style="color: #a020f0;">or</span> (<span style="color: #7a378b;">=</span> type <span style="color: #7a378b;">:buy</span>) (<span style="color: #7a378b;">=</span> type <span style="color: #7a378b;">:buy-stop</span>) (<span style="color: #7a378b;">=</span> type <span style="color: #7a378b;">:buy-limit</span>)))
(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">hit?</span> [order val]
  (<span style="color: #a020f0;">cond</span>
   (sell? order)
   (<span style="color: #7a378b;">&lt;=</span> (close) val)
   (buy? order)
   (<span style="color: #7a378b;">&gt;=</span> (close) val )
   true (throwf <span style="color: #8b2252;">"invalid order type %s"</span> order)))
<span style="color: #b22222;">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span style="color: #b22222;">
</span>(<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">method-regex</span>
  (<span style="color: #7a378b;">re-pattern</span> (.replaceAll
               (<span style="color: #7a378b;">str</span> <span style="color: #8b2252;">"(?i)\\s*(Propulsion|Pip Reactor|Impulse|Spring)\\s+Method"</span>
                    <span style="color: #8b2252;">".+running on (\\w+/\\w+)"</span>
                    <span style="color: #8b2252;">".+generated a (Buy|Sell) Signal @ (\\d{0,15}\\.\\d{0,15})"</span>
                    <span style="color: #8b2252;">".+Stop @ (\\d{0,15}\\.\\d{0,15})"</span>
                    <span style="color: #8b2252;">".+(?:1st|First) Limit @ (\\d{0,15}\\.\\d{0,15})"</span>
                    <span style="color: #8b2252;">".+(?:2nd|Second) Limit @ (\\d{0,15}\\.\\d{0,15})"</span>) 
               <span style="color: #8b2252;">"\\s+"</span> <span style="color: #8b2252;">"\\\\s+"</span>)))

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">catch-un</span> [&amp; body]
  `(<span style="color: #a020f0;">try</span> (<span style="color: #a020f0;">do</span> ~@body) (<span style="color: #a020f0;">catch</span> Exception e# (warn <span style="color: #8b2252;">"caught unexpected error: %s"</span> e#))))

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">match-method</span> [s]
  (<span style="color: #a020f0;">when</span> s 
    (debugging <span style="color: #8b2252;">"Matching Profit Multiplier Trade: "</span>
               (catch-un 
                (<span style="color: #a020f0;">when-let</span> [it (<span style="color: #7a378b;">first</span> (<span style="color: #7a378b;">re-seq</span> method-regex (.replaceAll s <span style="color: #8b2252;">"[\\r\\n]+"</span> <span style="color: #8b2252;">" "</span>)))]
                  (<span style="color: #a020f0;">let</span> [[method-type symbol type price stop tp1 tp2] (<span style="color: #7a378b;">rest</span> it)]
                    {<span style="color: #7a378b;">:method</span> (.toLowerCase method-type)
                     <span style="color: #7a378b;">:symbol</span> (.replaceAll symbol <span style="color: #8b2252;">"/"</span> <span style="color: #8b2252;">""</span>)
                     <span style="color: #7a378b;">:type</span> (<span style="color: #a020f0;">condp</span> = (.toLowerCase type)
                               <span style="color: #8b2252;">"buy"</span> <span style="color: #7a378b;">:buy-stop</span>
                               <span style="color: #8b2252;">"sell"</span> <span style="color: #7a378b;">:sell-stop</span>)
                     <span style="color: #7a378b;">:price</span> (Double/parseDouble price)
                     <span style="color: #7a378b;">:sl</span> (Double/parseDouble stop)
                     <span style="color: #7a378b;">:tp1</span> (Double/parseDouble tp1)
                     <span style="color: #7a378b;">:tp2</span> (Double/parseDouble tp2)}))))))
<span style="color: #b22222;">;;;;;;;;;;;;;;;;;;;;;;</span><span style="color: #b22222;">ea
</span><span style="color: #b22222;">;;</span><span style="color: #b22222;">TODO: mql error 146
</span>
(<span style="color: #7a378b;">declare</span> timeout break-even trail)

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">init</span> [{<span style="color: #7a378b;">:keys</span> [type sl price]}]
  (aif (order! (atom-hash {<span style="color: #7a378b;">:type</span> type <span style="color: #7a378b;">:sl</span> sl <span style="color: #7a378b;">:price</span> price
                           <span style="color: #7a378b;">:lots</span> (<span style="color: #7a378b;">*</span> (mode-minlot) 2)}))
       {<span style="color: #7a378b;">:end-time</span> (plus (now) (hours 12))
        <span style="color: #7a378b;">:state</span> (<span style="color: #7a378b;">atom</span> <span style="color: #7a378b;">:timeout</span>)
        <span style="color: #7a378b;">:order</span> it} 
       (out <span style="color: #8b2252;">"MQL error %s"</span> (<span style="color: #7a378b;">:e</span> it))))

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">start</span> [{state <span style="color: #7a378b;">:state</span> order <span style="color: #7a378b;">:order</span> <span style="color: #7a378b;">:as</span> self} args]
  (<span style="color: #a020f0;">cond</span>
   (close? order) (exit <span style="color: #8b2252;">"order is now closed"</span>)
   (<span style="color: #7a378b;">=</span> @state <span style="color: #7a378b;">:timeout</span>) (timeout self)
   (<span style="color: #7a378b;">=</span> @state <span style="color: #7a378b;">:break-even</span>) (break-even order args))) 

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">timeout</span> [{<span style="color: #7a378b;">:keys</span> [order state end-time]}]
  (<span style="color: #a020f0;">cond</span>
   <span style="color: #b22222;">;;</span><span style="color: #b22222;">changed to market
</span>   (market? order)
   (<span style="color: #a020f0;">do</span> (<span style="color: #7a378b;">reset!</span> state <span style="color: #7a378b;">:break-even</span>) (out <span style="color: #8b2252;">"changed to break even"</span>))
   <span style="color: #b22222;">;;</span><span style="color: #b22222;">entry order reach sl 
</span>   (<span style="color: #a020f0;">if</span> (sell? order) (<span style="color: #7a378b;">&gt;</span> (close) (<span style="color: #7a378b;">:sl</span> order)) (<span style="color: #7a378b;">&lt;</span> (close) (<span style="color: #7a378b;">:sl</span> order)))
   <span style="color: #b22222;">;;</span><span style="color: #b22222;">TODO: reliable delete????
</span>   (<span style="color: #a020f0;">do</span> (delete! order) (out <span style="color: #8b2252;">"entry order reached sl. deleting ..."</span>))
   <span style="color: #b22222;">;;</span><span style="color: #b22222;">timed out
</span>   (after? (now) end-time)
   (awhen (delete! order) (exit <span style="color: #8b2252;">"order timed out"</span>))))

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">break-even</span>
  [order {<span style="color: #7a378b;">:keys</span> [tp1 tp2]}]
  (<span style="color: #a020f0;">when</span> (hit? order tp1)
    (out <span style="color: #8b2252;">"closing to half ..."</span>)
    (awhen (<span style="color: #a020f0;">-&gt;</span> (close! order (<span style="color: #7a378b;">int</span> (<span style="color: #7a378b;">/</span> (<span style="color: #7a378b;">:lots</span> order) 2)))
               (modify! {<span style="color: #7a378b;">:sl</span> (<span style="color: #7a378b;">:price</span> order) <span style="color: #7a378b;">:tp</span> tp2}))
           (exit <span style="color: #8b2252;">"finished break even - closing ..."</span>))))

(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">hh</span> [a]
  (<span style="color: #7a378b;">apply</span> max (<span style="color: #7a378b;">map</span> high (<span style="color: #7a378b;">range</span> 1 (<span style="color: #7a378b;">inc</span> a)))))
(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">ll</span> [a]
  (<span style="color: #7a378b;">apply</span> min (<span style="color: #7a378b;">map</span> low (<span style="color: #7a378b;">range</span> 1 (<span style="color: #7a378b;">inc</span> a)))))
(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">trail</span>
  <span style="color: #8b2252;">"initiate a trailing stop = hh3 or ll3"</span>
  [order]
  (modify! order
           {<span style="color: #7a378b;">:sl</span> (<span style="color: #a020f0;">if</span> (sell? order)
                  (<span style="color: #7a378b;">min</span> (<span style="color: #7a378b;">:sl</span> order) (hh 3))
                  (<span style="color: #7a378b;">max</span> (<span style="color: #7a378b;">:sl</span> order) (ll 3)))}))

<span style="color: #b22222;">;;</span><span style="color: #b22222;">TODO: stop a specific node
</span>(<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">a</span> nil)
(<span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">trade-it</span> []
  (<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">ea</span> (run {<span style="color: #7a378b;">:name</span> <span style="color: #8b2252;">"timeout"</span> <span style="color: #7a378b;">:symbol</span> (<span style="color: #7a378b;">:symbol</span> a)
                <span style="color: #7a378b;">:init</span> init <span style="color: #7a378b;">:start</span> #'start} a)))
</pre></div>




</div>
</div>
</div>
<div id="postamble">
<p class="author"> Author: Seth Burleigh
</p>
<p class="date"> Date: 2011-01-13 16:47:22 CST</p>
<p class="creator">HTML generated by org-mode 7.4 in emacs 23</p>
</div>
</div>
</body>
</html>
